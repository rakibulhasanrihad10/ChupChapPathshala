{% if current_user.is_authenticated %}

<!-- Chat Window -->
<template id="chat-window-template">
    <div class="chatbot-window active" data-uid="" style="position: fixed; bottom: 0; right: 7rem; width: 328px; height: 455px; z-index: 999;">
        <!-- Header -->
        <div class="chatbot-header">
            <div class="chatbot-header-info">
                <img src="" class="chatbot-avatar user-avatar" style="object-fit: cover; padding: 0;">
                <div class="chatbot-title">
                    <h3 class="user-name">User</h3>
                    <p>Online</p>
                </div>
            </div>
            <button onclick="closeChat(event, this)" class="chatbot-close" aria-label="Close chat">
                <span>Ã—</span>
            </button>
        </div>
        
        <!-- Messages Area -->
        <div class="chatbot-messages chat-messages">
            <!-- Messages will be inserted here -->
        </div>
        
        <!-- Input Area -->
        <div class="chatbot-input">
            <input 
                type="text" 
                name="body"
                placeholder="Type your message..."
                autocomplete="off"
            />
            <button type="button" onclick="sendMessageFromInput(this)" class="chatbot-send-btn" aria-label="Send message">
                <span>âž¤</span>
            </button>
        </div>
    </div>
</template>

<script>
    const activeChats = new Set();
    const chatWindows = new Map();
    
    function openChat(userId, username, photoUrl) {
        if (activeChats.has(userId)) {
            const existingWindow = chatWindows.get(userId);
            if (existingWindow) {
                existingWindow.style.zIndex = '1000';
            }
            return;
        }
        
        if (activeChats.size >= 3) {
            alert("Please close a chat window first (maximum 3 windows).");
            return;
        }
        
        activeChats.add(userId);
        
        const template = document.getElementById('chat-window-template');
        const clone = template.content.cloneNode(true);
        const win = clone.querySelector('.chatbot-window');
        
        win.setAttribute('data-uid', userId);
        win.querySelector('.user-name').textContent = username;
        
        const img = win.querySelector('.user-avatar');
        img.src = photoUrl || 'https://placehold.co/150x150';
        
        const windowIndex = activeChats.size - 1;
        const baseRight = 7; 
        const windowWidth = 328; 
        const gap = 8; 
        
        if (windowIndex === 0) {
            win.style.right = `${baseRight}rem`;
        } else {
            win.style.right = `calc(${baseRight}rem + ${windowIndex * (windowWidth + gap)}px)`;
        }
        
        document.body.appendChild(win);
        chatWindows.set(userId, win);
        
        loadMessages(userId, win.querySelector('.chat-messages'));
        
        // Start polling
        win.pollInterval = setInterval(() => loadMessages(userId, win.querySelector('.chat-messages'), true), 5000);
        
        // Setup enter key
        const input = win.querySelector('input[name="body"]');
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessageFromInput(win.querySelector('.chatbot-send-btn'));
            }
        });
    }
    
    function closeChat(e, btn) {
        e.stopPropagation();
        const win = btn.closest('[data-uid]');
        const uid = parseInt(win.getAttribute('data-uid'));
        clearInterval(win.pollInterval);
        activeChats.delete(uid);
        chatWindows.delete(uid);
        win.remove();
    }
    
    async function loadMessages(userId, container, isPoll=false) {
        try {
            const res = await fetch(`/messages/history/${userId}`);
            const data = await res.json();
            
            const messages = data.messages || [];
            const otherUser = data.other_user || {};
            
            if (isPoll && container.childElementCount === messages.length) {
                // Still update status even if no new messages
                updateChatStatus(userId, otherUser);
                return;
            }
            
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-message-icon">ðŸ’¬</div>
                        <h4>Start the conversation</h4>
                        <p>Send a message to begin chatting!</p>
                    </div>
                `;
            } else {
                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.is_mine ? 'user' : ''}`;
                    messageDiv.setAttribute('data-message-id', msg.id);
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'message-avatar';
                    
                    // Use actual profile photo instead of emoji
                    const avatarImg = document.createElement('img');
                    avatarImg.src = msg.sender_photo || 'https://placehold.co/150x150';
                    avatarImg.style.cssText = 'width: 100%; height: 100%; border-radius: 50%; object-fit: cover;';
                    avatarImg.alt = msg.sender_name;
                    avatar.appendChild(avatarImg);
                    
                    const content = document.createElement('div');
                    content.className = 'message-content';
                    content.setAttribute('data-original-text', msg.body);
                    
                    // Add deleted styling
                    if (msg.is_deleted) {
                        content.style.fontStyle = 'italic';
                        content.style.opacity = '0.6';
                    }
                    
                    content.textContent = msg.body;
                    content.title = msg.timestamp;
                    
                    // Add edited indicator
                    if (msg.edited_at && !msg.is_deleted) {
                        const editedSpan = document.createElement('span');
                        editedSpan.className = 'edited-indicator';
                        editedSpan.textContent = ' (edited)';
                        editedSpan.style.cssText = 'font-size: 0.75rem; opacity: 0.7; font-style: italic;';
                        content.appendChild(editedSpan);
                    }
                    
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(content);
                    
                    // Add edit/delete buttons for user's own messages (not deleted)
                    if (msg.is_mine && !msg.is_deleted) {
                        // Make message div relative for absolute positioning
                        messageDiv.style.position = 'relative';
                        
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'message-actions';
                        actionsDiv.style.cssText = 'position: absolute; top: 0.25rem; left: 0.25rem; display: none; gap: 0.25rem; background: rgba(0, 0, 0, 0.5); border-radius: 0.375rem; padding: 0.25rem;';
                        
                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>`;
                        editBtn.title = 'Edit message';
                        editBtn.style.cssText = 'background: none; border: none; cursor: pointer; opacity: 0.9; padding: 0.125rem; display: flex; align-items: center;';
                        editBtn.onclick = () => startEditMessage(msg.id, msg.body);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>`;
                        deleteBtn.title = 'Delete message';
                        deleteBtn.style.cssText = 'background: none; border: none; cursor: pointer; opacity: 0.9; padding: 0.125rem; display: flex; align-items: center;';
                        deleteBtn.onclick = () => deleteMessageConfirm(msg.id);
                        
                        actionsDiv.appendChild(editBtn);
                        actionsDiv.appendChild(deleteBtn);
                        messageDiv.appendChild(actionsDiv);
                        
                        // Show actions on hover
                        messageDiv.addEventListener('mouseenter', () => {
                            actionsDiv.style.display = 'flex';
                        });
                        messageDiv.addEventListener('mouseleave', () => {
                            actionsDiv.style.display = 'none';
                        });
                    }
                    
                    container.appendChild(messageDiv);
                });
            }
            
            container.scrollTop = container.scrollHeight;
            
            // Update status in header
            updateChatStatus(userId, otherUser);
            
        } catch (e) {
            console.error(e);
        }
    }
    
    function updateChatStatus(userId, otherUser) {
        const win = chatWindows.get(userId);
        if (!win) return;
        
        const statusElement = win.querySelector('.chatbot-title p');
        if (!statusElement) return;
        
        if (otherUser.is_online) {
            statusElement.textContent = 'Online';
            statusElement.style.color = '#10b981'; 
        } else if (otherUser.last_seen) {
            const lastSeen = new Date(otherUser.last_seen);
            const now = new Date();
            const diffMinutes = Math.floor((now - lastSeen) / 60000);
            
            if (diffMinutes < 60) {
                statusElement.textContent = `Active ${diffMinutes}m ago`;
            } else if (diffMinutes < 1440) {
                const hours = Math.floor(diffMinutes / 60);
                statusElement.textContent = `Active ${hours}h ago`;
            } else {
                const days = Math.floor(diffMinutes / 1440);
                statusElement.textContent = `Active ${days}d ago`;
            }
            statusElement.style.color = 'var(--text-muted)';
        } else {
            statusElement.textContent = 'Offline';
            statusElement.style.color = 'var(--text-muted)';
        }
    }
    
    async function sendMessageFromInput(btn) {
        const win = btn.closest('[data-uid]');
        const uid = win.getAttribute('data-uid');
        const input = win.querySelector('input[name="body"]');
        const body = input.value.trim();
        
        if (!body) return;
        
        try {
            const res = await fetch(`/messages/send/${uid}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({body: body})
            });
            
            if (res.ok) {
                input.value = '';
                loadMessages(uid, win.querySelector('.chat-messages'));
            }
        } catch (e) {
            console.error(e);
        }
    }
    
    function sendMessage(e, form) {
        e.preventDefault();
        const btn = form.querySelector('.chatbot-send-btn');
        sendMessageFromInput(btn);
    }
    
    function startEditMessage(messageId, currentText) {
        const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        if (!messageDiv) return;
        
        const contentDiv = messageDiv.querySelector('.message-content');
        const actionsDiv = messageDiv.querySelector('.message-actions');
        
        // Hide action buttons
        if (actionsDiv) actionsDiv.style.display = 'none';
        
        // Create edit input
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentText;
        input.style.cssText = 'width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-primary); color: var(--text-primary);';
        
        // Create save/cancel buttons
        const btnContainer = document.createElement('div');
        btnContainer.style.cssText = 'display: flex; gap: 0.5rem; margin-top: 0.5rem;';
        
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Save';
        saveBtn.style.cssText = 'padding: 0.25rem 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;';
        saveBtn.onclick = () => saveEditMessage(messageId, input.value);
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.cssText = 'padding: 0.25rem 0.75rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;';
        cancelBtn.onclick = () => {
            const win = messageDiv.closest('[data-uid]');
            const uid = parseInt(win.getAttribute('data-uid'));
            loadMessages(uid, win.querySelector('.chat-messages'));
        };
        
        btnContainer.appendChild(saveBtn);
        btnContainer.appendChild(cancelBtn);
        
        // Replace content with edit UI
        contentDiv.innerHTML = '';
        contentDiv.appendChild(input);
        contentDiv.appendChild(btnContainer);
        input.focus();
        
        // Save on Enter
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveEditMessage(messageId, input.value);
            }
        });
    }
    
    async function saveEditMessage(messageId, newText) {
        if (!newText.trim()) {
            alert('Message cannot be empty');
            return;
        }
        
        try {
            const res = await fetch(`/messages/edit/${messageId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({body: newText})
            });
            
            const data = await res.json();
            
            if (res.ok) {
                // Reload messages
                const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
                const win = messageDiv.closest('[data-uid]');
                const uid = parseInt(win.getAttribute('data-uid'));
                loadMessages(uid, win.querySelector('.chat-messages'));
            } else {
                alert(data.error || 'Failed to edit message');
            }
        } catch (e) {
            console.error(e);
            alert('Error editing message');
        }
    }
    
    function deleteMessageConfirm(messageId) {
        if (!confirm('Are you sure you want to delete this message?')) {
            return;
        }
        deleteMessageAction(messageId);
    }
    
    async function deleteMessageAction(messageId) {
        try {
            const res = await fetch(`/messages/delete/${messageId}`, {
                method: 'DELETE'
            });
            
            const data = await res.json();
            
            if (res.ok) {
                // Reload messages
                const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
                const win = messageDiv.closest('[data-uid]');
                const uid = parseInt(win.getAttribute('data-uid'));
                loadMessages(uid, win.querySelector('.chat-messages'));
            } else {
                alert(data.error || 'Failed to delete message');
            }
        } catch (e) {
            console.error(e);
            alert('Error deleting message');
        }
    }

</script>
{% endif %}
