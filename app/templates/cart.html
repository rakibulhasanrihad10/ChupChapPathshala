{% extends "base.html" %}

{% block title %}Shopping Cart{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Your Shopping Cart</h1>
    <a href="{{ url_for('main.catalog') }}"
        style="color: #4F46E5; font-weight: 500; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
        &larr; Continue Shopping
    </a>
</div>

{% if items %}
<!-- Wrap everything in form for selective checkout -->
<form action="{{ url_for('main.checkout_review') }}" method="POST" id="cartForm">
    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem; align-items: start;">

        <!-- Cart Items Table -->
<!-- Cart Items Table -->
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" checked onchange="toggleAll(this)" style="width: 18px; height: 18px; cursor: pointer;">
                        </th>
                        <th style="width: 40%;">Book</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Qty</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr id="row-{{ item.id }}">
                        <td>
                            <input type="checkbox" name="selected_items" value="{{ item.id }}" checked 
                                class="item-checkbox" 
                                data-price="{{ item.book.sale_price if item.action == 'buy' else 0 }}"
                                data-qty="{{ item.quantity }}"
                                data-action="{{ item.action }}"
                                onchange="calculateTotal()"
                                style="width: 18px; height: 18px; cursor: pointer;">
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <!-- Tiny Thumbnail -->
                                <div
                                    style="width: 40px; height: 60px; background: var(--bg-color); border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                                    <img src="{{ item.book.image_url or 'https://placehold.co/40x60?text=No+Img' }}" alt=""
                                        class="book-thumb-img" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-color);">{{ item.book.title }}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-muted);">{{ item.book.author }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span
                                style="padding: 2px 8px; border-radius: 9999px; background: var(--pill-bg); color: var(--pill-text); font-size: 0.75rem; font-weight: 600;">{{
                                item.action|capitalize }}</span>
                        </td>
                        <td>
                            {% if item.action == 'buy' %}
                                {% if item.book.discount_percentage and item.book.discount_percentage > 0 %}
                                    <div style="display: flex; flex-direction: column;">
                                        <span class="text-red-500 line-through text-xs">TK {{ "%.2f"|format(item.book.price) }}</span>
                                        <span class="price-unit text-green-600 font-bold">TK {{ "%.2f"|format(item.book.sale_price) }}</span>
                                    </div>
                                {% else %}
                                    <span class="price-unit">TK {{ "%.2f"|format(item.book.price) }}</span>
                                {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px; background: var(--pill-bg); border-radius: 6px; padding: 2px 6px; width: fit-content;">
                                <button type="button" onclick="updateQty({{ item.id }}, 'decrease')" 
                                    style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; color: var(--text-muted); font-weight: bold;">-</button>
                                <span id="qty-{{ item.id }}" style="font-weight: 600; font-size: 0.9rem; min-width: 20px; text-align: center; color: var(--text-color);">{{ item.quantity }}</span>
                                <button type="button" onclick="updateQty({{ item.id }}, 'increase')"
                                    style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; color: var(--primary-color); font-weight: bold;">+</button>
                            </div>
                        </td>
                        <td>
                            {% if item.action == 'buy' %}
                            TK <span id="total-{{ item.id }}" class="item-total">{{ "%.2f"|format(item.book.sale_price * item.quantity) }}</span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('main.remove_from_cart', item_id=item.id) }}"
                                style="color: #EF4444; text-decoration: none; font-size: 0.875rem; font-weight: 500;">Remove</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Checkout Summary Card -->
        <div
            style="background: var(--card-bg); padding: 1.5rem; border-radius: 1rem; box-shadow: var(--shadow); position: sticky; top: 2rem;">
            <h3
                style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; color: var(--text-color);">
                Summary</h3>

            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 1rem;">
                <span style="color: var(--text-muted);">Selected Items (<span id="count-display">0</span>)</span>
                <span style="font-weight: 600; color: var(--text-color);">TK <span id="subtotal-display">0.00</span></span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 1rem;">
                <span style="color: var(--text-muted);">Delivery Charge</span>
                <span style="font-weight: 600; color: var(--text-color);">TK <span id="delivery-display">60.00</span></span>
            </div>
            
            <div style="height: 1px; background: var(--border-color); margin: 1rem 0;"></div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; font-size: 1.1rem;">
                <span style="color: var(--text-color); font-weight: 700;">Total</span>
                <span style="font-weight: 700; color: var(--primary-color);">TK <span id="final-total-display">0.00</span></span>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label
                    style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-color);">Promo
                    Code</label>
                <input type="text" name="coupon_code" placeholder="Enter code"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); border-radius: 0.5rem; outline: none;">
            </div>
            
            <button type="submit" class="btn-action btn-borrow" style="font-size: 1rem; padding: 0.75rem;">
                Proceed to Checkout
            </button>
        </div>

    </div>
</form>
{% else %}
<div style="text-align: center; padding: 4rem; background: var(--card-bg); border-radius: 1rem; box-shadow: var(--shadow);">
    <div style="margin-bottom: 1.5rem; color: var(--text-muted);">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
    </div>
    <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--text-color); margin-bottom: 0.5rem;">Your cart is empty</h3>
    <p style="color: var(--text-muted); margin-bottom: 2rem;">Looks like you haven't added any books yet.</p>
    <a href="{{ url_for('main.catalog') }}" class="btn btn-primary">Browse Books</a>
</div>
{% endif %}

<script>
    const DELIVERY_CHARGE = 60.00;

    function toggleAll(source) {
        checkboxes = document.querySelectorAll('.item-checkbox');
        for(var i=0, n=checkboxes.length;i<n;i++) {
            checkboxes[i].checked = source.checked;
        }
        calculateTotal();
    }

    function calculateTotal() {
        let subtotal = 0;
        let count = 0;
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');
        
        checkboxes.forEach(cb => {
            count++;
            const price = parseFloat(cb.dataset.price);
            const qty = parseInt(cb.dataset.qty);
            subtotal += price * qty;
        });

        document.getElementById('count-display').innerText = count;
        document.getElementById('subtotal-display').innerText = subtotal.toFixed(2);
        
        // Add delivery charge only if items are selected
        const finalDelivery = count > 0 ? DELIVERY_CHARGE : 0;
        document.getElementById('delivery-display').innerText = finalDelivery.toFixed(2);
        
        document.getElementById('final-total-display').innerText = (subtotal + finalDelivery).toFixed(2);
    }

    function updateQty(itemId, action) {
        // Disable buttons temporarily
        // Send AJAX
        fetch(`/cart/update/${itemId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ action: action })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                
                const qtySpan = document.getElementById(`qty-${itemId}`);
                const row = document.getElementById(`row-${itemId}`);
                const checkbox = row.querySelector('.item-checkbox');
                
                qtySpan.innerText = data.quantity;
                checkbox.dataset.qty = data.quantity;
                
                // Update Item Total if visible
                const itemTotal = document.getElementById(`total-${itemId}`);
                if (itemTotal) itemTotal.innerText = data.item_total.toFixed(1);
                
                calculateTotal(); 
            } else {
                alert(data.error || 'Failed to update quantity');
            }
        })
        .catch(err => console.error('Error:', err));
    }
    
    document.addEventListener('DOMContentLoaded', calculateTotal);
</script>
{% endblock %}