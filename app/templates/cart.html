{% extends "base.html" %}

{% block title %}Shopping Cart{% endblock %}

{% block head %}
<style>
    /* Cart Layout */
    .cart-layout {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 2rem;
        align-items: start;
    }

    /* Cart Items Container */
    .cart-items {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    /* Select All Header */
    .select-all-header {
        padding: 1rem;
        background: var(--card-bg);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }

    /* Cart Item Card */
    .cart-item {
        display: grid;
        grid-template-columns: auto 1fr auto auto auto auto;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
        background: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: var(--shadow);
    }

    .cart-item-checkbox {
        display: flex;
        align-items: center;
    }

    .cart-item-info {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .cart-item-image {
        width: 60px;
        height: 90px;
        border-radius: 0.375rem;
        overflow: hidden;
        background: var(--bg-color);
        flex-shrink: 0;
    }

    .cart-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .cart-item-details {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .cart-item-title {
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.9375rem;
    }

    .cart-item-author {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .cart-item-type {
        margin-top: 0.25rem;
    }

    .type-badge {
        padding: 2px 8px;
        border-radius: 9999px;
        background: var(--pill-bg);
        color: var(--pill-text);
        font-size: 0.75rem;
        font-weight: 600;
    }

    .cart-item-price, .cart-item-total {
        text-align: center;
        min-width: 80px;
    }

    .cart-item-qty {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .qty-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        display: none;
    }

    .qty-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--pill-bg);
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
    }

    .qty-btn {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: transparent;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        color: var(--text-color);
        transition: color 0.2s;
    }

    .qty-btn:hover {
        color: var(--primary-color);
    }

    .qty-value {
        font-weight: 600;
        min-width: 24px;
        text-align: center;
        color: var(--text-color);
    }

    .cart-item-remove {
        display: flex;
        align-items: center;
    }

    .remove-btn {
        color: #EF4444;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: opacity 0.2s;
    }

    .remove-btn:hover {
        opacity: 0.8;
    }

    /* Mobile-only elements */
    .mobile-only {
        display: none;
    }

    .cart-item-mobile-price {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .mobile-price-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .cart-layout {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .select-all-header {
            display: none;
        }

        .cart-item {
            grid-template-columns: auto 1fr;
            grid-template-areas:
                "checkbox info"
                "checkbox qty"
                "checkbox mobile-price"
                "checkbox remove";
            gap: 0.75rem;
            padding: 0.875rem;
        }

        .cart-item-checkbox {
            grid-area: checkbox;
            align-self: start;
            padding-top: 0.25rem;
        }

        .cart-item-info {
            grid-area: info;
        }

        .cart-item-image {
            width: 50px;
            height: 75px;
        }

        .cart-item-qty {
            grid-area: qty;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
        }

        .qty-label {
            display: block;
        }

        .cart-item-mobile-price {
            grid-area: mobile-price;
        }

        .cart-item-remove {
            grid-area: remove;
        }

        .desktop-only {
            display: none !important;
        }

        .mobile-only {
            display: flex;
        }
    }

    @media (max-width: 480px) {
        .cart-item-image {
            width: 45px;
            height: 68px;
        }

        .cart-item-title {
            font-size: 0.875rem;
        }

        .cart-item-author {
            font-size: 0.8125rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Your Shopping Cart</h1>
    <a href="{{ url_for('main.catalog') }}"
        style="color: #4F46E5; font-weight: 500; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
        &larr; Continue Shopping
    </a>
</div>

{% if items %}
<!-- Wrap everything in form for selective checkout -->
<form action="{{ url_for('main.checkout_review') }}" method="POST" id="cartForm">
    <div class="cart-layout">

        <!-- Cart Items -->
        <div class="cart-items">
            <!-- Select All Header (Desktop Only) -->
            <div class="select-all-header">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="selectAll" checked onchange="toggleAll(this)" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: 600; color: var(--text-color);">Select All</span>
                </label>
            </div>

            <!-- Cart Items List -->
            {% for item in items %}
            <div class="cart-item" id="row-{{ item.id }}">
                <!-- Checkbox -->
                <div class="cart-item-checkbox">
                    <input type="checkbox" name="selected_items" value="{{ item.id }}" checked 
                        class="item-checkbox" 
                        data-price="{{ item.book.sale_price if item.action == 'buy' else 0 }}"
                        data-qty="{{ item.quantity }}"
                        data-action="{{ item.action }}"
                        onchange="calculateTotal()"
                        style="width: 18px; height: 18px; cursor: pointer;">
                </div>

                <!-- Book Info -->
                <div class="cart-item-info">
                    <div class="cart-item-image">
                        <img src="{{ item.book.image_url or 'https://placehold.co/80x120?text=No+Img' }}" 
                             alt="{{ item.book.title }}"
                             class="book-thumb-img">
                    </div>
                    <div class="cart-item-details">
                        <div class="cart-item-title">{{ item.book.title }}</div>
                        <div class="cart-item-author">{{ item.book.author }}</div>
                        <div class="cart-item-type">
                            <span class="type-badge">{{ item.action|capitalize }}</span>
                        </div>
                    </div>
                </div>

                <!-- Price (Desktop) -->
                <div class="cart-item-price desktop-only">
                    {% if item.action == 'buy' %}
                        {% if item.book.discount_percentage and item.book.discount_percentage > 0 %}
                            <div style="display: flex; flex-direction: column;">
                                <span style="color: #EF4444; text-decoration: line-through; font-size: 0.75rem;">TK {{ "%.2f"|format(item.book.price) }}</span>
                                <span style="color: #10B981; font-weight: 700;">TK {{ "%.2f"|format(item.book.sale_price) }}</span>
                            </div>
                        {% else %}
                            <span style="font-weight: 600; color: var(--text-color);">TK {{ "%.2f"|format(item.book.price) }}</span>
                        {% endif %}
                    {% else %}
                        <span style="color: var(--text-muted);">-</span>
                    {% endif %}
                </div>

                <!-- Quantity Controls -->
                <div class="cart-item-qty">
                    <div class="qty-label">Qty:</div>
                    <div class="qty-controls">
                        <button type="button" onclick="updateQty({{ item.id }}, 'decrease')" class="qty-btn">-</button>
                        <span id="qty-{{ item.id }}" class="qty-value">{{ item.quantity }}</span>
                        <button type="button" onclick="updateQty({{ item.id }}, 'increase')" class="qty-btn">+</button>
                    </div>
                </div>

                <!-- Total (Desktop) -->
                <div class="cart-item-total desktop-only">
                    {% if item.action == 'buy' %}
                        <span style="font-weight: 700; color: var(--text-color);">TK <span id="total-{{ item.id }}" class="item-total">{{ "%.2f"|format(item.book.sale_price * item.quantity) }}</span></span>
                    {% else %}
                        <span style="color: var(--text-muted);">-</span>
                    {% endif %}
                </div>

                <!-- Mobile Price & Total -->
                <div class="cart-item-mobile-price mobile-only">
                    {% if item.action == 'buy' %}
                        <div class="mobile-price-row">
                            <span style="color: var(--text-muted); font-size: 0.875rem;">Price:</span>
                            {% if item.book.discount_percentage and item.book.discount_percentage > 0 %}
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: #EF4444; text-decoration: line-through; font-size: 0.75rem;">TK {{ "%.2f"|format(item.book.price) }}</span>
                                    <span style="color: #10B981; font-weight: 700;">TK {{ "%.2f"|format(item.book.sale_price) }}</span>
                                </div>
                            {% else %}
                                <span style="font-weight: 600;">TK {{ "%.2f"|format(item.book.price) }}</span>
                            {% endif %}
                        </div>
                        <div class="mobile-price-row">
                            <span style="color: var(--text-muted); font-size: 0.875rem;">Total:</span>
                            <span style="font-weight: 700; color: var(--primary-color);">TK <span id="total-mobile-{{ item.id }}">{{ "%.2f"|format(item.book.sale_price * item.quantity) }}</span></span>
                        </div>
                    {% endif %}
                </div>

                <!-- Remove Button -->
                <div class="cart-item-remove">
                    <a href="{{ url_for('main.remove_from_cart', item_id=item.id) }}" class="remove-btn">Remove</a>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Checkout Summary Card -->
        <div
            style="background: var(--card-bg); padding: 1.5rem; border-radius: 1rem; box-shadow: var(--shadow); position: sticky; top: 2rem;">
            <h3
                style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; color: var(--text-color);">
                Summary</h3>

            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 1rem;">
                <span style="color: var(--text-muted);">Selected Items (<span id="count-display">0</span>)</span>
                <span style="font-weight: 600; color: var(--text-color);">TK <span id="subtotal-display">0.00</span></span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 1rem;">
                <span style="color: var(--text-muted);">Delivery Charge</span>
                <span style="font-weight: 600; color: var(--text-color);">TK <span id="delivery-display">60.00</span></span>
            </div>
            
            <div style="height: 1px; background: var(--border-color); margin: 1rem 0;"></div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; font-size: 1.1rem;">
                <span style="color: var(--text-color); font-weight: 700;">Total</span>
                <span style="font-weight: 700; color: var(--primary-color);">TK <span id="final-total-display">0.00</span></span>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label
                    style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-color);">Promo
                    Code</label>
                <input type="text" name="coupon_code" placeholder="Enter code"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); border-radius: 0.5rem; outline: none;">
            </div>
            
            <button type="submit" class="btn-action btn-borrow" style="font-size: 1rem; padding: 0.75rem;">
                Proceed to Checkout
            </button>
        </div>

    </div>
</form>
{% else %}
<div style="text-align: center; padding: 4rem; background: var(--card-bg); border-radius: 1rem; box-shadow: var(--shadow);">
    <div style="margin-bottom: 1.5rem; color: var(--text-muted);">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
    </div>
    <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--text-color); margin-bottom: 0.5rem;">Your cart is empty</h3>
    <p style="color: var(--text-muted); margin-bottom: 2rem;">Looks like you haven't added any books yet.</p>
    <a href="{{ url_for('main.catalog') }}" class="btn btn-primary">Browse Books</a>
</div>
{% endif %}

<script>
    const DELIVERY_CHARGE = 60.00;

    function toggleAll(source) {
        checkboxes = document.querySelectorAll('.item-checkbox');
        for(var i=0, n=checkboxes.length;i<n;i++) {
            checkboxes[i].checked = source.checked;
        }
        calculateTotal();
    }

    function calculateTotal() {
        let subtotal = 0;
        let count = 0;
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');
        
        checkboxes.forEach(cb => {
            count++;
            const price = parseFloat(cb.dataset.price);
            const qty = parseInt(cb.dataset.qty);
            subtotal += price * qty;
        });

        document.getElementById('count-display').innerText = count;
        document.getElementById('subtotal-display').innerText = subtotal.toFixed(2);
        
        // Add delivery charge only if items are selected
        const finalDelivery = count > 0 ? DELIVERY_CHARGE : 0;
        document.getElementById('delivery-display').innerText = finalDelivery.toFixed(2);
        
        document.getElementById('final-total-display').innerText = (subtotal + finalDelivery).toFixed(2);
    }

    function updateQty(itemId, action) {
        // Disable buttons temporarily
        // Send AJAX
        fetch(`/cart/update/${itemId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ action: action })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                
                const qtySpan = document.getElementById(`qty-${itemId}`);
                const row = document.getElementById(`row-${itemId}`);
                const checkbox = row.querySelector('.item-checkbox');
                
                qtySpan.innerText = data.quantity;
                checkbox.dataset.qty = data.quantity;
                
                // Update Item Total if visible
                const itemTotal = document.getElementById(`total-${itemId}`);
                if (itemTotal) itemTotal.innerText = data.item_total.toFixed(1);
                
                calculateTotal(); 
            } else {
                alert(data.error || 'Failed to update quantity');
            }
        })
        .catch(err => console.error('Error:', err));
    }
    
    document.addEventListener('DOMContentLoaded', calculateTotal);
</script>
{% endblock %}