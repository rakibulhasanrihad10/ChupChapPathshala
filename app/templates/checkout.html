{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block head %}
<style>
    /* Checkout Layout */
    .checkout-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
        align-items: start;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .checkout-layout {
            grid-template-columns: 1fr;
        }
        
        .order-summary-sticky {
            position: static !important;
        }
    }

    @media (max-width: 768px) {
        .checkout-layout {
            gap: 1.5rem;
        }
        
        .card {
            padding: 1.25rem !important;
        }
        
        .page-header h1 {
            font-size: 1.5rem !important;
        }
    }

    @media (max-width: 480px) {
        .checkout-layout {
            gap: 1rem;
        }
        
        .card {
            padding: 1rem !important;
        }
        
        .card h2 {
            font-size: 1.25rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Checkout</h1>
    <a href="{{ url_for('main.view_cart') }}"
        style="color: #4F46E5; font-weight: 500; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
        &larr; Back to Cart
    </a>
</div>

<form action="{{ url_for('main.confirm_checkout') }}" method="POST">
    {{ form.hidden_tag() }}
    <!-- Hidden Fields -->
    <input type="hidden" name="selected_ids" value="{{ selected_ids }}">
    <input type="hidden" name="coupon_code" value="{{ coupon_code or '' }}">
    
    <div class="checkout-layout">
        
        <!-- Shipping Information -->
        <div class="card" style="background: var(--card-bg); box-shadow: var(--shadow);">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-color);">Shipping Information</h2>
            
            <div style="display: grid; gap: 1.5rem;">
                <!-- Name -->
                <div>
                    {{ form.name.label(style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-color);") }}
                    {{ form.name(class="form-control", style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); border-radius: 0.5rem; outline: none;") }}
                    {% if form.name.errors %}
                        <div style="color: #EF4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.name.errors[0] }}</div>
                    {% endif %}
                </div>
                
                <!-- Phone -->
                <div>
                    {{ form.phone.label(style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-color);") }}
                    {{ form.phone(class="form-control", placeholder="01712345678", style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); border-radius: 0.5rem; outline: none;") }}
                    {% if form.phone.errors %}
                        <div style="color: #EF4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.phone.errors[0] }}</div>
                    {% endif %}
                </div>
                
                <!-- Address -->
                <div>
                    {{ form.address.label(style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-color);") }}
                    {{ form.address(class="form-control", rows="3", placeholder="House #, Road #, Area...", style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); border-radius: 0.5rem; outline: none; font-family: inherit;") }}
                    {% if form.address.errors %}
                        <div style="color: #EF4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.address.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="card order-summary-sticky" style="position: sticky; top: 2rem; background: var(--card-bg); box-shadow: var(--shadow);">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-color);">Order Summary</h2>
            
            <div style="margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto;">
                {% for item in items %}
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                     <div style="width: 50px; height: 75px; background: var(--bg-color); border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                        <img src="{{ item.book.image_url or 'https://placehold.co/50x75?text=Img' }}" alt=""
                            class="book-thumb-img" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-color); font-size: 0.95rem;">{{ item.book.title }}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Qty: {{ item.quantity }}</div>
                        {% if item.action == 'buy' %}
                        <div style="font-weight: 500; color: var(--primary-color); margin-top: 0.25rem;">
                            {% if item.book.discount_percentage and item.book.discount_percentage > 0 %}
                            <div style="display: flex; flex-direction: column;">
                                <span class="text-red-500 line-through text-xs">TK {{ "%.2f"|format(item.book.price * item.quantity) }}</span>
                                <span>TK {{ "%.2f"|format(item.book.sale_price * item.quantity) }}</span>
                            </div>
                            {% else %}
                            TK {{ "%.2f"|format(item.book.sale_price * item.quantity) }}
                            {% endif %}
                        </div>
                        {% else %}
                        <div style="font-size: 0.85rem; color: #10B981; margin-top: 0.25rem;">Borrow</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--text-color);">
                <span>Subtotal</span>
                <span style="font-weight: 600;">TK {{ subtotal }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--text-color);">
                <span>Delivery Charge</span>
                <span style="font-weight: 600;">TK {{ delivery_charge }}</span>
            </div>
            
            {% if discount > 0 %}
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #10B981;">
                <span>Discount</span>
                <span style="font-weight: 600;">- TK {{ discount }}</span>
            </div>
            {% endif %}

            <div style="height: 1px; background: var(--border-color); margin: 1rem 0;"></div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 700; color: var(--text-color);">
                <span>Total</span>
                <span style="color: var(--primary-color);">TK {{ total }}</span>
            </div>

            <button type="submit" class="btn-action btn-buy" style="font-size: 1.1rem; padding: 1rem;">
                Place Order
            </button>
            
            <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-muted); text-align: center;">
                By placing this order, you agree to our Terms of Service.
            </div>
        </div>
        
    </div>
</form>
{% endblock %}
