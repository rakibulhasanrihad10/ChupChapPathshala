{% extends "base.html" %}

{% block title %}Catalog{% endblock %}

{% block content %}
<h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 2rem; color: var(--text-color);">All Books</h2>

    <!-- Category Filter -->
    <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
        <!-- Category Filter -->
        <div class="filter-row" style="display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.5rem; -ms-overflow-style: none; scrollbar-width: none; align-items: center;">
            <span style="font-weight: 600; color: #4B5563; min-width: max-content;">Category:</span>
            
            <!-- Search Trigger -->
            <button onclick="toggleFilterSearch(this)" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Search Categories" style="color: var(--text-muted);">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
            <input type="text" placeholder="Filter..." onkeyup="filterChips(this)" 
                   class="hidden border rounded px-2 py-1 text-sm outline-none shadow-sm transition-all"
                   style="width: 120px; border-color: var(--border-color); background-color: var(--bg-color); color: var(--text-color);">

            <a href="{{ url_for('main.catalog', sort=current_sort, per_page=current_per_page) }}" 
               class="filter-chip glass-chip {{ 'active' if not current_category else '' }}">
               All Books
            </a>
            {% for cat in categories %}
            <a href="{{ url_for('main.catalog', category=cat, sort=current_sort, per_page=current_per_page) }}" 
               class="filter-chip glass-chip {{ 'active' if current_category == cat else '' }}">
               {{ cat }}
            </a>
            {% endfor %}
        </div>
        
        <!-- Author Filter -->
        <div class="filter-row" style="display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.5rem; -ms-overflow-style: none; scrollbar-width: none; align-items: center;">
            <span style="font-weight: 600; color: #4B5563; min-width: max-content;">Author:</span>
            
             <!-- Search Trigger -->
            <button onclick="toggleFilterSearch(this)" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Search Authors" style="color: var(--text-muted);">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
            <input type="text" placeholder="Filter..." onkeyup="filterChips(this)" 
                   class="hidden border rounded px-2 py-1 text-sm outline-none shadow-sm transition-all"
                   style="width: 120px; border-color: var(--border-color); background-color: var(--bg-color); color: var(--text-color);">

            <a href="{{ url_for('main.catalog', category=current_category, sort=current_sort, per_page=current_per_page) }}" 
               class="filter-chip glass-chip {{ 'active' if not current_author else '' }}">
               All Authors
            </a>
            {% for author in authors %}
            <a href="{{ url_for('main.catalog', category=current_category, author=author, sort=current_sort, per_page=current_per_page) }}" 
               class="filter-chip glass-chip {{ 'active' if current_author == author else '' }}">
               {{ author }}
            </a>
            {% endfor %}
        </div>

        <!-- Sort Filter -->
        <div style="display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.5rem; -ms-overflow-style: none; scrollbar-width: none; align-items: center;">
            <span style="font-weight: 600; color: #4B5563; min-width: max-content;">Sort By:</span>
            {% set sort_options = [
                ('a to z', 'A to Z'),
                ('z to a', 'Z to A'),
                ('low to high', 'Price: Low to High'),
                ('high to low', 'Price: High to Low')
            ] %}
            
            {% for value, label in sort_options %}
            <a href="{{ url_for('main.catalog', category=current_category, author=current_author, sort=value, per_page=current_per_page) }}" 
               class="filter-chip glass-chip {{ 'active' if current_sort == value else '' }}">
               {{ label }}
            </a>
            {% endfor %}
            
            {% if current_sort %}
            <a href="{{ url_for('main.catalog', category=current_category, author=current_author, per_page=current_per_page) }}" 
               style="white-space: nowrap; padding: 0.4rem 1rem; text-decoration: none; font-size: 0.9em; color: #EF4444; font-weight: 500;">
               ✕ Clear Sort
            </a>
            {% endif %}
        </div>
    </div>
<div class="features-grid">
    {% for book in books %}
    <div class="card">
        <div class="book-image-container">
            {% if book.image_url %}
            <img src="{{ book.image_url }}" alt="{{ book.title }}"
                id="img-{{ book.id }}">
            {% else %}
            <div class="no-cover-placeholder" id="img-{{ book.id }}">
                <span>No Cover</span>
            </div>
            {% endif %}
            
            {% if book.discount_percentage and book.discount_percentage > 0 %}
            <div class="discount-badge">
                <span class="discount-value">{{ "%.0f"|format(book.discount_percentage) }}%</span>
                <span class="discount-label">OFF</span>
            </div>
            {% endif %}
            
            {% if current_user.is_staff() %}
            <div class="upload-overlay" onclick="document.getElementById('file-{{ book.id }}').click()">
                <div class="upload-btn">+</div>
            </div>
            <!-- Loading Spinner -->
            <div id="spinner-{{ book.id }}" class="upload-spinner">↻</div>
            
            <input type="file" id="file-{{ book.id }}" accept="image/*" style="display: none;" 
                   onchange="uploadCover(this, {{ book.id }})">
            {% endif %}
        </div>
        <h3>{{ book.title }}</h3>
        <p class="text-sm mb-1"><strong>Author:</strong> {{ book.author }}</p>
        <p class="text-sm mb-1"><strong>Availability:</strong> <span
                class="status-badge">{{
                book.item_type|capitalize }}</span></p>
        <p class="text-sm mb-1"><strong>Category:</strong> <span style="color: #6B7280;">{{ book.category }}</span></p>
        <p class="text-sm mb-1">
            <strong>Price:</strong>
            {% if book.discount_percentage and book.discount_percentage > 0 %}
                <span class="text-red-500 line-through mr-1">TK {{ "%.2f"|format(book.price) }}</span>
                <span class="text-green-600 font-bold">TK {{ "%.2f"|format(book.price * (1 - book.discount_percentage/100)) }}</span>
                {% else %}
                TK {{ "%.2f"|format(book.price) }}
            {% endif %}
        </p>
        <p class="text-sm"><strong>Stock:</strong> {{ book.stock_available }}</p>

        <!-- Action Buttons Grid -->
        <div style="margin-top: auto; padding-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            
            {% set show_buy = (book.item_type in ['sale', 'hybrid'] and book.stock_available > 0) %}
            {% set show_borrow = (book.item_type in ['circulation', 'hybrid'] and book.stock_available > 0) %}
            {% set show_locate = (current_user.is_authenticated and current_user.is_staff()) %}
            
            <form action="{{ url_for('main.add_to_cart', book_id=book.id) }}" method="POST" style="display: contents;">
                {% if show_buy %}
                <button type="submit" name="action" value="buy" class="btn-action btn-buy" 
                    style="{{ 'grid-column: span 2;' if not show_borrow and not show_locate else '' }}">Buy</button>
                {% endif %}

                {% if show_borrow %}
                <button type="submit" name="action" value="borrow" class="btn-action btn-borrow"
                    style="{{ 'grid-column: span 2;' if not show_buy and not show_locate else '' }}">Borrow</button>
                {% endif %}

                {% if book.stock_available == 0 %}
                <button disabled class="btn-action btn-disabled" style="grid-column: span 2;">Out of Stock</button>
                {% endif %}
            </form>

            {% if show_locate %}
            <form action="{{ url_for('main.inventory') }}" method="GET" style="display: contents;">
              <button type="submit" name="target" value={{book.id}} class="btn-action btn-borrow" 
                style="{{ 'grid-column: span 2;' if (show_buy and show_borrow) else '' }}">Locate</button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination Controls -->
{% if pagination %}
<div class="mt-12 flex flex-col gap-6">
    {% if pagination.pages > 1 %}
    <!-- Navigation Bar -->
    <div class="flex items-center justify-between w-full">
        <!-- PREV Button -->
        <div class="w-20">
        {% if pagination.has_prev %}
            <a href="{{ url_for('main.catalog', page=pagination.prev_num, category=current_category, author=current_author, sort=current_sort, per_page=current_per_page) }}"
               class="text-xs font-bold uppercase tracking-widest transition hover:text-red-600"
               style="color: var(--text-muted);">
                PREV
            </a>
        {% endif %}
        </div>

        <!-- Page Numbers Timeline -->
        <nav class="flex items-center gap-1" aria-label="Pagination">
            {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=3) %}
                {% if p %}
                    <a href="{{ url_for('main.catalog', page=p, category=current_category, author=current_author, sort=current_sort, per_page=current_per_page) }}"
                       class="w-8 h-8 flex items-center justify-center text-xs font-bold rounded-lg transition-all"
                       style="{{ 'background-color: #dc2626; color: #ffffff; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);' if p == pagination.page else 'color: var(--text-color); background-color: rgba(128, 128, 128, 0.08);' }}">
                        {{ p }}
                    </a>
                {% else %}
                    <span class="px-1 text-xs" style="color: var(--text-muted);">...</span>
                {% endif %}
            {% endfor %}
        </nav>

        <!-- NEXT Button -->
        <div class="w-20 text-right">
        {% if pagination.has_next %}
            <a href="{{ url_for('main.catalog', page=pagination.next_num, category=current_category, author=current_author, sort=current_sort, per_page=current_per_page) }}"
               class="text-xs font-bold uppercase tracking-widest transition hover:text-red-600"
               style="color: var(--text-muted);">
                NEXT
            </a>
        {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Summary & Page Size Info -->
    <div class="flex flex-col sm:flex-row items-center justify-center sm:justify-between gap-4">
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium" style="color: var(--text-muted);">Show:</span>
            <select onchange="updatePageSize(this.value)" 
                    class="bg-transparent border rounded px-1 text-sm outline-none transition"
                    style="color: var(--text-color); border-color: var(--border-color); background-color: var(--card-bg);">
                {% for size in [5, 10, 20, 50] %}
                <option value="{{ size }}" {{ 'selected' if current_per_page == size }}>{{ size }}</option>
                {% endfor %}
            </select>
        </div>
        <p class="text-sm font-medium" style="color: var(--text-muted);">
            Showing {{ (pagination.page - 1) * pagination.per_page + 1 }} to {{ (pagination.page - 1) * pagination.per_page + books|length }} of {{ pagination.total }} ({{ pagination.pages }} Pages)
        </p>
    </div>
</div>
{% endif %}

<script>
    function toggleFilterSearch(btn) {
        const input = btn.nextElementSibling;
        if (input.classList.contains('hidden')) {
            input.classList.remove('hidden');
            input.focus();
        } else {
            input.classList.add('hidden');
            input.value = '';
            filterChips(input); // Reset
        }
    }

    function filterChips(input) {
        const filterText = input.value.toLowerCase();
        const container = input.closest('.filter-row');
        const chips = container.querySelectorAll('.filter-chip');

        chips.forEach(chip => {
            const text = chip.textContent.toLowerCase();
            if (text.includes(filterText)) {
                chip.style.display = '';
            } else {
                chip.style.display = 'none';
            }
        });
    }

    function uploadCover(input, bookId) {
        if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Client-side validation: Check file size (16MB limit)
        if (file.size > 16 * 1024 * 1024) {
            alert('File is too large. Maximum size is 16MB.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        
        // Show Spinner / Hide overlay
        const spinner = document.getElementById(`spinner-${bookId}`);
        
        if(spinner) spinner.style.display = 'block';
        
        fetch(`/upload_cover/${bookId}`, {
            method: 'POST',
            body: formData
        })
        .then(async response => {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            } else {
                const text = await response.text();
                throw new Error(`Server returned non-JSON response: ${response.status} ${response.statusText}. Response: ${text.substring(0, 100)}...`);
            }
        })
        .then(data => {
            if (data.success) {
                // Update Image Source
                const img = document.getElementById(`img-${bookId}`);
                if(img) img.src = data.image_url + '?t=' + new Date().getTime();
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed. Check console for details.\n' + error.message);
        })
        .finally(() => {
            if(spinner) spinner.style.display = 'none';
            input.value = '';
        });
    }
}

function updatePageSize(size) {
    const url = new URL(window.location.href);
    url.searchParams.set('per_page', size);
    url.searchParams.set('page', 1); // Reset to page 1 on size change
    window.location.href = url.toString();
}
</script>
{% endblock %}
