{% extends "base.html" %}

{% block title %}Catalog{% endblock %}

{% block content %}
<h2>Library Catalog</h2>

    <!-- Category Filter -->
    <div style="display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.5rem; margin-bottom: 2rem; -ms-overflow-style: none; scrollbar-width: none;">
        <a href="{{ url_for('main.catalog') }}" 
           style="white-space: nowrap; padding: 0.5rem 1.25rem; border-radius: 9999px; text-decoration: none; font-weight: 500; transition: all 0.2s box-shadow; 
                  {{ 'background-color: #4F46E5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);' if not current_category else 'background-color: #F3F4F6; color: #374151;' }}">
           All Books
        </a>
        {% for cat in categories %}
        <a href="{{ url_for('main.catalog', category=cat) }}" 
           style="white-space: nowrap; padding: 0.5rem 1.25rem; border-radius: 9999px; text-decoration: none; font-weight: 500; transition: all 0.2s box-shadow;
                  {{ 'background-color: #4F46E5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);' if current_category == cat else 'background-color: #F3F4F6; color: #374151;' }}">
           {{ cat }}
        </a>
        {% endfor %}
    </div>
<div class="features-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
    {% for book in books %}
    <div class="card" style="display: flex; flex-direction: column; overflow: hidden;">
        <div class="book-image-container">
            <img src="{{ book.image_url or 'https://placehold.co/150x220?text=No+Cover' }}" alt="{{ book.title }}"
                style="height: 100%; width: 100%; object-fit: cover;" id="img-{{ book.id }}">
            
            {% if current_user.is_staff() %}
            <div class="upload-overlay" onclick="document.getElementById('file-{{ book.id }}').click()">
                <div class="upload-btn">+</div>
            </div>
            <!-- Loading Spinner -->
            <div id="spinner-{{ book.id }}" class="upload-spinner">â†»</div>
            
            <input type="file" id="file-{{ book.id }}" accept="image/*" style="display: none;" 
                   onchange="uploadCover(this, {{ book.id }})">
            {% endif %}
        </div>
        <h3>{{ book.title }}</h3>
        <p><strong>Author:</strong> {{ book.author }}</p>
        <p><strong>Availability:</strong> <span
                style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">{{
                book.item_type|capitalize }}</span></p>
        <p><strong>Category:</strong> <span style="color: #6B7280;">{{ book.category }}</span></p>
        <p><strong>Price:</strong> {{ "%.2f"|format(book.price) }}</p>
        <p><strong>Creating Stock:</strong> {{ book.stock_available }}</p>

        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <form action="{{ url_for('main.add_to_cart', book_id=book.id) }}" method="POST" style="width: 100%;">
                {% if book.item_type in ['sale', 'hybrid'] and book.stock_available > 0 %}
                <button type="submit" name="action" value="buy" class="btn-action btn-buy"
                    style="margin-bottom: 0.5rem;">Buy</button>
                {% endif %}

                {% if book.item_type in ['circulation', 'hybrid'] and book.stock_available > 0 %}
                <button type="submit" name="action" value="borrow" class="btn-action btn-borrow">Borrow</button>
                {% endif %}

                {% if book.stock_available == 0 %}
                <button disabled
                    class="btn-action btn-disabled">Out of Stock</button>
                {% endif %}
            </form>
        </div>
    </div>
    {% endfor %}
</div>

<script>
function uploadCover(input, bookId) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Client-side validation: Check file size (16MB limit)
        if (file.size > 16 * 1024 * 1024) {
            alert('File is too large. Maximum size is 16MB.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        
        // Show Spinner / Hide overlay
        const spinner = document.getElementById(`spinner-${bookId}`);
        
        if(spinner) spinner.style.display = 'block';
        
        fetch(`/upload_cover/${bookId}`, {
            method: 'POST',
            body: formData
        })
        .then(async response => {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            } else {
                const text = await response.text();
                throw new Error(`Server returned non-JSON response: ${response.status} ${response.statusText}. Response: ${text.substring(0, 100)}...`);
            }
        })
        .then(data => {
            if (data.success) {
                // Update Image Source
                const img = document.getElementById(`img-${bookId}`);
                if(img) img.src = data.image_url + '?t=' + new Date().getTime();
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed. Check console for details.\n' + error.message);
        })
        .finally(() => {
            if(spinner) spinner.style.display = 'none';
            input.value = '';
        });
    }
}
</script>
{% endblock %}