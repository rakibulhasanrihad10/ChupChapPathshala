{% extends "base.html" %}

{% block title %}Profile - ChupChap Pathshala{% endblock %}

{% block content %}
  <div class="max-w-7xl mx-auto">

    <!-- Cover & Avatar -->
    <div class="relative">
      <img src="{{ current_user.cover_photo or 'https://placehold.co/1200x400/1e3a8a/FFF?text=Cover+Photo' }}"
           class="w-full h-56 object-cover rounded-lg">
           <div class="absolute -bottom-14 left-6">
             <img src="{{ current_user.profile_photo or 'https://placehold.co/200x200/4F46E5/FFF?text=Me' }}"
                  class="w-28 h-28 rounded-full border-4 border-white shadow-md bg-white">
           </div>
    </div>

    <!-- User Info -->
    <div class="mt-20 px-6">
      <h1 class="text-3xl font-bold text-gray-900">{{ current_user.username }}</h1>
      <p class="text-gray-600">{{ current_user.email }}</p>

      <div class="flex flex-wrap gap-4 mt-4 text-sm">
        <span class="px-3 py-1 rounded-full bg-gray-100">Role: {{ current_user.role|capitalize }}</span>
        <span class="px-3 py-1 rounded-full bg-gray-100">Membership: {{ current_user.membership_type|capitalize }}</span>
        {% if current_user.membership_expiry %}
          <span class="px-3 py-1 rounded-full bg-gray-100">
            Expires: {{ current_user.membership_expiry.strftime('%Y-%m-%d') }}
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8 px-6 rounded-lg w-full">
      <a href="#active-loans" class="block">
        <div class="p-4 rounded-lg bg-white shadow text-center hover:shadow-md transition">
          <p class="text-sm text-gray-500">Active Loans</p>
          <p class="text-3xl font-bold text-gray-900">{{ active_loans|length }}</p>
        </div>
      </a>
      <a href="#active-loans" class="block">
        <div class="p-4 rounded-lg bg-white shadow text-center hover:shadow-md transition">
          <p class="text-sm text-gray-500">Overdue</p>
          <p class="text-3xl font-bold text-red-600">{{ overdue_loans|length }}</p>
        </div>
      </a>
      <a href="#purchases" class="block">
        <div class="p-4 rounded-lg bg-white shadow text-center hover:shadow-md transition">
          <p class="text-sm text-gray-500">Purchases</p>
          <p class="text-3xl font-bold text-gray-900">{{ sales|length }}</p>
        </div>
      </a>
      <a href="#forum-posts" class="block">
        <div class="p-4 rounded-lg bg-white shadow text-center hover:shadow-md transition">
          <p class="text-sm text-gray-500">Forum Posts</p>
          <p class="text-3xl font-bold text-gray-900">{{ forum_posts|length }}</p>
        </div>
      </a>
    </div>

    <!-- Profile Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-10 px-6">

      <!-- Left Sidebar: Intro -->
      <div class="md:col-span-1">
        <div class="p-6 rounded-xl shadow-sm space-y-4" style="background-color: var(--card-bg);">
          <h3 class="text-xl font-bold" style="color: var(--text-color);">About</h3>

          <div class="space-y-3" style="color: var(--text-muted);">
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5" style="color: var(--text-muted);" fill="none" stroke="currentColor"
                   viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                         d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                   </path>
              </svg>
              <span>{{ current_user.email if current_user.is_authenticated and current_user.id == current_user.id else
                '*******@***.com' }}</span>
            </div>

            <div class="flex items-center gap-3">
              <svg class="w-5 h-5" style="color: var(--text-muted);" fill="none" stroke="currentColor"
                   viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                         d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.2-2.85.577-4.147">
                   </path>
              </svg>
              <span>Joined {{ current_user.membership_expiry.strftime('%B %Y') if current_user.membership_expiry else 'Recently'
                }}</span>
            </div>

            <div class="flex items-center gap-3">
              <svg class="w-5 h-5" style="color: var(--text-muted);" fill="none" stroke="currentColor"
                   viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                         d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                               d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                         </path>
              </svg>
              <span>Member Status: {{ current_user.membership_type|capitalize }}</span>
            </div>
          </div>

          {% if current_user.is_authenticated and current_user.id == current_user.id %}
            <div class="pt-4 border-t" style="border-color: var(--border-color);">
              <a href="{{ url_for('auth.logout') }}" class="w-full btn-action"
                 style="background-color: #FEE2E2; color: #991B1B; justify-content: center;">
                 Logout
              </a>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Right Content -->
      <div class="md:col-span-2 space-y-6">

		<!-- Active Loans -->
		<div id="active-loans" class="p-6 rounded-xl shadow-sm bg-white scroll-mt-24">
          <h3 class="text-xl font-bold mb-4">Active Loans</h3>
          {% if active_loans %}
			<div class="overflow-x-auto">
              {% for loan in active_loans %}
				<div class="flex items-start gap-4 p-4 rounded-lg border"
                     style="border-color: var(--border-color); background-color: var(--bg-color);">
                     <!-- Book Thumb -->
                     <div class="flex-shrink-0 w-16 h-24 overflow-hidden rounded"
                          style="background-color: var(--border-color);">
                          <img src="{{ loan.book.image_url or 'https://placehold.co/100x150?text=No+Cover' }}"
                               alt="{{ loan.book.title }}" class="w-full h-full object-cover book-thumb-img">
                     </div>

                     <div class="flex-1 min-w-0">
                       <div class="flex justify-between items-center">
                         <div>
                           <h4 class="text-lg font-bold truncate" style="color: var(--text-color);">{{
                             loan.book.title }}</h4>
                             <p class="text-sm font-medium" style="color: var(--text-muted);">{{ loan.book.author }}
                             </p>
                         </div>

                         <!-- Status Badge -->
						 <div class ='group'>
                      
								 <form action="{{ url_for('user.return_loan', loan_id=loan.id) }}" method="POST">
                                   <button type="submit"
                                           class="hover:bg-red-300 px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-md bg-red-100 text-red-800 border border-red-200">
                                           Return
                                   </button>
                                 </form>
						
						 </div>
                       </div>

                       <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                         <div>
                           <p class="text-xs uppercase tracking-wide" style="color: var(--text-muted);">Borrowed
                           </p>
                           <p class="font-medium" style="color: var(--text-color);">{{
                             loan.checkout_date.strftime('%b %d, %Y') }}</p>
                         </div>
                         <div>
                           <p class="text-xs uppercase tracking-wide" style="color: var(--text-muted);">
                             {% if loan.status == 'returned' %}Returned On{% else %}Due Date{% endif %}
                           </p>
                           <p class="font-medium" style="color: var(--text-color);">
                             {% if loan.status == 'returned' %}
                               {{ loan.return_date.strftime('%b %d, %Y') if loan.return_date else '-' }}
                             {% else %}
                               {{ loan.due_date.strftime('%b %d, %Y') }}
                               {% if loan.status == 'active' %}
                                 <span
                                   class="ml-1 text-xs font-bold {{ 'text-red-500' if loan.days_remaining < 3 else 'text-green-500' }}">
                                   ({{ 'Overdue' if loan.days_remaining < 0 else loan.days_remaining ~ ' days left'
                                   }}) </span>
                                 {% endif %}
                               {% endif %}
																		  </p>
                         </div>
                       </div>
                     </div>
                </div>
                
              {% endfor %}
			</div>
          {% else %}
            <p class="text-gray-500">No active loans.</p>
          {% endif %}
        </div>
		<!-- Borrowing History (Private) -->
        {% if current_user.is_authenticated and current_user.id == user.id %}
          {% if loans %}
			<div class="p-6 rounded-xl shadow-sm" style="background-color: var(--card-bg);">
              <h3 class="text-xl font-bold mb-6" style="color: var(--text-color);">Borrowing History</h3>

              <div class="space-y-4">
                {% for loan in loans %}
                  <div class="flex items-start gap-4 p-4 rounded-lg border"
                       style="border-color: var(--border-color); background-color: var(--bg-color);">
                       <!-- Book Thumb -->
                       <div class="flex-shrink-0 w-16 h-24 overflow-hidden rounded"
							style="background-color: var(--border-color);">
							<img src="{{ loan.book.image_url or 'https://placehold.co/100x150?text=No+Cover' }}"
								 alt="{{ loan.book.title }}" class="w-full h-full object-cover book-thumb-img">
                       </div>

                       <div class="flex-1 min-w-0">
                         <div class="flex justify-between items-center">
                           <div>
                             <h4 class="text-lg font-bold truncate" style="color: var(--text-color);">{{
                               loan.book.title }}</h4>
                               <p class="text-sm font-medium" style="color: var(--text-muted);">{{ loan.book.author }}
                               </p>
                           </div>

                           <!-- Status Badge -->
						   <div class ='group'>
                             {% if loan.status == 'returned' %}
                               <span
                                 class="px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-md bg-green-100 text-green-800 border border-green-200">Returned</span>
                               {% elif loan.days_remaining < 0 %} <span
                                 class="group-hover:hidden px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-md bg-red-100 text-red-800 border border-red-200">
                                 Overdue</span>
                               {% else %}
                                 <span
                                   class="group-hover:hidden px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-md bg-blue-100 text-blue-800 border border-blue-200">Active</span>
                                 {% endif %}
								 {% if loan.status == 'active' %}
								   <form action="{{ url_for('user.return_loan', loan_id=loan.id) }}" method="POST">
                                     <button type="submit"
                                             class="hidden group-hover:inline px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-md bg-red-100 text-red-800 border border-red-200">
                                             Return
                                     </button>
                                   </form>
								 {% endif %}
						   </div>
                         </div>

                         <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                           <div>
                             <p class="text-xs uppercase tracking-wide" style="color: var(--text-muted);">Borrowed
                             </p>
                             <p class="font-medium" style="color: var(--text-color);">{{
                               loan.checkout_date.strftime('%b %d, %Y') }}</p>
                           </div>
                           <div>
                             <p class="text-xs uppercase tracking-wide" style="color: var(--text-muted);">
                               {% if loan.status == 'returned' %}Returned On{% else %}Due Date{% endif %}
                             </p>
                             <p class="font-medium" style="color: var(--text-color);">
                               {% if loan.status == 'returned' %}
                                 {{ loan.return_date.strftime('%b %d, %Y') if loan.return_date else '-' }}
                               {% else %}
                                 {{ loan.due_date.strftime('%b %d, %Y') }}
                                 {% if loan.status == 'active' %}
                                   <span
                                     class="ml-1 text-xs font-bold {{ 'text-red-500' if loan.days_remaining < 3 else 'text-green-500' }}">
                                     ({{ 'Overdue' if loan.days_remaining < 0 else loan.days_remaining ~ ' days left'
                                     }}) </span>
                                   {% endif %}
                                 {% endif %}
																			</p>
                           </div>
                         </div>
                       </div>
                  </div>
                {% endfor %}
              </div>
			</div>
          {% else %}
			<!-- Placeholder for Loans -->
			<div class="p-6 rounded-xl shadow-sm text-center py-12" style="background-color: var(--card-bg);">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4"
                   style="background-color: var(--bg-color);">
                   <svg class="w-8 h-8" style="color: var(--text-muted);" fill="none" stroke="currentColor"
						viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
						</path>
                   </svg>
              </div>
              <h3 class="text-lg font-medium" style="color: var(--text-color);">No borrowing history yet</h3>
              <p class="mt-2" style="color: var(--text-muted);">Books you borrow or buy will appear here.</p>
              <a href="{{ url_for('main.catalog') }}" class="mt-4 inline-block font-medium hover:text-indigo-500"
                 style="color: var(--primary-color);">
                 Browse Catalog &rarr;
              </a>
			</div>
          {% endif %}
        {% endif %}
        <!-- Purchase History -->
            <div id="purchases" class="p-6 rounded-xl shadow-sm bg-white scroll-mt-24">
              <h3 class="text-xl font-bold mb-4">Recent Purchases</h3>
              {% if sales %}
                <div class="overflow-x-auto">
                  <table class="w-full text-left text-sm">
                    <thead class="bg-gray-100 text-gray-700">
                      <tr>
                        <th class="p-3">Book</th>
                        <th class="p-3">Price</th>
                        <th class="p-3">Date</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for sale in sales %}
                        <tr class="border-t">
                          <td class="p-3 font-medium">{{ sale.book.title }}</td>
                          <td class="p-3">{{ "%.2f"|format(sale.price_at_sale) }}</td>
                          <td class="p-3">{{ sale.sale_date.strftime('%Y-%m-%d') }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="text-gray-500">No purchases yet.</p>
              {% endif %}
            </div>

            <!-- Forum Activity -->
            <div id="forum-posts" class="p-6 rounded-xl shadow-sm bg-white scroll-mt-24">
              <h3 class="text-xl font-bold mb-4">Your Forum Posts</h3>
              {% if forum_posts %}
                {% for post in forum_posts %}
                  <a href="{{ url_for('forum.view_post', post_id=post.id) }}"
					 class="block p-4 bg-gray-50 rounded-lg shadow hover:shadow-md transition mb-3">
                     <div class="flex justify-between items-center">
                       <h4 class="font-semibold">{{ post.title }}</h4>
                       <span class="text-xs px-2 py-1 rounded bg-gray-100">{{ post.status }}</span>
                     </div>
                     <p class="text-sm text-gray-600 mt-1">{{ post.created_at.strftime('%Y-%m-%d') }}</p>
                  </a>
                {% endfor %}
              {% else %}
                <p class="text-gray-500">You haven't posted yet.</p>
              {% endif %}
            </div>

      </div>
    </div>
  </div>
{% endblock %}
