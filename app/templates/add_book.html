{% extends "base.html" %}

{% block title %}Add New Book{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Add New Book</h1>
</div>

<div
    style="background: white; padding: 2rem; border-radius: 1rem; box-shadow: var(--shadow); max-width: 600px; margin: 0 auto;">
    <form method="POST">
        <!-- ISBN Search Section -->
        <div
            style="background: #F3F4F6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border: 1px dashed #9CA3AF;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #4B5563;">Auto-fill
                Details</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="isbn_search" placeholder="Enter ISBN (e.g. 9780140328721)"
                    style="flex: 1; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; outline: none;">
                <button type="button" onclick="fetchBookByISBN()"
                    style="background: #4F46E5; color: white; padding: 0 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">
                    Search
                </button>
            </div>
            <p id="search_status" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6B7280;"></p>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">Title</label>
            <input type="text" name="title" required
                style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; outline: none; transition: border-color 0.2s;">
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">Author</label>
            <input type="text" name="author" required
                style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; outline: none; transition: border-color 0.2s;">
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">Image URL
                (Poster)</label>
            <input type="url" name="image_url" placeholder="https://..."
                style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; outline: none; transition: border-color 0.2s;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">Price</label>
                <input type="number" step="0.01" name="price" required
                    style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; outline: none; transition: border-color 0.2s;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">Total
                    Stock</label>
                <input type="number" name="stock_total" value="1" required
                    style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; outline: none; transition: border-color 0.2s;">
            </div>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">Category</label>
            <select name="category"
                style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; outline: none; background: white;">
                <option value="General">General</option>
                <option value="Bengali">Bengali</option>
                <option value="Islamic">Islamic</option>
                <option value="Fiction">Fiction</option>
                <option value="Non-Fiction">Non-Fiction</option>
                <option value="Academic">Academic</option>
                <option value="Children">Children</option>
            </select>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">Availability
                (Sale/Borrow)</label>
            <select name="item_type"
                style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; outline: none; background: white;">
                <option value="circulation">Circulation (Borrow Only)</option>
                <option value="sale">Sale (Purchase Only)</option>
                <option value="hybrid">Hybrid (Both)</option>
            </select>
        </div>

        <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">Location</label>
            <input type="text" name="location" placeholder="e.g. Aisle 3, Shelf B"
                style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; outline: none; transition: border-color 0.2s;">
        </div>

        <div style="display: flex; gap: 1rem; align-items: center;">
            <input type="submit" value="Add Book" class="btn-add"
                style="border: none; cursor: pointer; font-size: 1rem;">
            <a href="{{ url_for('main.inventory') }}"
                style="color: #6B7280; text-decoration: none; font-weight: 500;">Cancel</a>
        </div>
    </form>
</div>

<script>
    async function fetchBookByISBN() {
        const isbnInput = document.getElementById('isbn_search');
        const statusMsg = document.getElementById('search_status');
        const isbn = isbnInput.value.trim().replace(/-/g, '');

        if (!isbn) {
            statusMsg.textContent = 'Please enter an ISBN number.';
            statusMsg.style.color = '#EF4444';
            return;
        }

        statusMsg.textContent = 'Searching Open Library...';
        statusMsg.style.color = '#6B7280';

        try {
            const response = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&jscmd=data&format=json`);
            const data = await response.json();
            const bookData = data[`ISBN:${isbn}`];

            if (bookData) {
                // Populate Fields
                document.querySelector('input[name="title"]').value = bookData.title || '';

                if (bookData.authors && bookData.authors.length > 0) {
                    document.querySelector('input[name="author"]').value = bookData.authors[0].name;
                }

                if (bookData.cover) {
                    document.querySelector('input[name="image_url"]').value = bookData.cover.large || bookData.cover.medium || bookData.cover.small || '';
                }

                // Attempt to guess category (Subjects)
                if (bookData.subjects) {
                    const subjects = bookData.subjects.map(s => s.name.toLowerCase());
                    const categorySelect = document.querySelector('select[name="category"]');

                    if (subjects.some(s => s.includes('islam'))) categorySelect.value = 'Islamic';
                    else if (subjects.some(s => s.includes('bengali') || s.includes('india'))) categorySelect.value = 'Bengali';
                    else if (subjects.some(s => s.includes('fiction'))) categorySelect.value = 'Fiction';
                    else if (subjects.some(s => s.includes('history') || s.includes('science'))) categorySelect.value = 'Non-Fiction';
                }

                statusMsg.textContent = 'Success! details found.';
                statusMsg.style.color = '#059669';
            } else {
                statusMsg.textContent = 'Book not found for this ISBN.';
                statusMsg.style.color = '#EF4444';
            }
        } catch (error) {
            console.error(error);
            statusMsg.textContent = 'Error fetching data. Please try again.';
            statusMsg.style.color = '#EF4444';
        }
    }
</script>
{% endblock %}