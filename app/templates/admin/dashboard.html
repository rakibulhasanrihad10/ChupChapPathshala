{% extends "admin/admin_base.html" %}

{% block admin_content %}
<!-- Header -->
<div class="mb-8">
    <h1 class="text-4xl font-extrabold tracking-tight mb-2" style="color: var(--text-color);">Dashboard Overview
    </h1>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Customer Orders -->
    <div class="stat-card rounded-2xl p-6 shadow-lg border transition-all hover:scale-105 hover:shadow-2xl cursor-pointer"
        style="background-color: var(--card-bg); border-color: var(--border-color); border-left: 4px solid #3b82f6;"
        onclick="openStatModal('customerOrdersModal')" title="Click to view pending customer orders">
        <div class="flex items-center justify-between mb-3">
            <div class="p-3 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600">
                <i class="fas fa-shopping-bag text-2xl"></i>
            </div>
            {% if stats.pending_customer_orders > 0 %}
            <span class="trend-indicator up">
                <i class="fas fa-clock"></i>
                NEW
            </span>
            {% endif %}
        </div>
        <p class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Customer Orders</p>
        <h3 class="text-3xl font-bold" style="color: var(--text-color);">{{ stats.pending_customer_orders }}</h3>
        <p class="text-xs mt-2" style="color: var(--text-muted);">
            {% if stats.pending_customer_orders == 0 %}
            <span class="text-green-500">All orders delivered! âœ“</span>
            {% else %}
            Awaiting delivery
            {% endif %}
        </p>
    </div>

    <!-- Total Books -->
    <div class="stat-card rounded-2xl p-6 shadow-lg border transition-all hover:scale-105 hover:shadow-2xl cursor-pointer"
        style="background-color: var(--card-bg); border-color: var(--border-color); border-left: 4px solid #a855f7;"
        onclick="openStatModal('booksModal')" title="Click to view book inventory">
        <div class="flex items-center justify-between mb-3">
            <div class="p-3 rounded-xl bg-gradient-to-br from-purple-100 to-purple-200 text-purple-600">
                <i class="fas fa-book text-2xl"></i>
            </div>
        </div>
        <p class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Total Books
        </p>
        <h3 class="text-3xl font-bold" style="color: var(--text-color);">{{ stats.total_books }}</h3>
        <p class="text-xs mt-2" style="color: var(--text-muted);">
            {% if stats.total_books == 0 %}
            <span class="text-amber-500">Catalog is empty!</span>
            {% else %}
            In collection
            {% endif %}
        </p>
    </div>

    <!-- Active Loans -->
    <div class="stat-card rounded-2xl p-6 shadow-lg border transition-all hover:scale-105 hover:shadow-2xl cursor-pointer"
        style="background-color: var(--card-bg); border-color: var(--border-color); border-left: 4px solid #f59e0b;"
        onclick="openStatModal('loansModal')" title="Click to view active loans">
        <div class="flex items-center justify-between mb-3">
            <div class="p-3 rounded-xl bg-gradient-to-br from-amber-100 to-amber-200 text-amber-600">
                <i class="fas fa-hand-holding-heart text-2xl"></i>
            </div>
        </div>
        <p class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Active
            Loans</p>
        <h3 class="text-3xl font-bold" style="color: var(--text-color);">{{ stats.active_loans }}</h3>
        {% if stats.overdue_count > 0 %}
        <p class="text-xs mt-2 flex items-center gap-1">
            <i class="fas fa-exclamation-circle text-red-500"></i>
            <span class="text-red-500 font-semibold">{{ stats.overdue_count }} overdue</span>
        </p>
        {% else %}
        <p class="text-xs mt-2" style="color: var(--text-muted);">
            {% if stats.active_loans == 0 %}
            <span class="text-green-500">All books available! ðŸ“š</span>
            {% else %}
            <span class="text-green-500">All on time âœ“</span>
            {% endif %}
        </p>
        {% endif %}
    </div>

    <!-- Supply Orders -->
    <div class="stat-card rounded-2xl p-6 shadow-lg border transition-all hover:scale-105 hover:shadow-2xl cursor-pointer"
        style="background-color: var(--card-bg); border-color: var(--border-color); border-left: 4px solid #22c55e;"
        onclick="openStatModal('ordersModal')" title="Click to view supply orders">
        <div class="flex items-center justify-between mb-3">
            <div class="p-3 rounded-xl bg-gradient-to-br from-emerald-100 to-emerald-200 text-emerald-600">
                <i class="fas fa-truck-loading text-2xl"></i>
            </div>
        </div>
        <p class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Supply
            Orders</p>
        <h3 class="text-3xl font-bold" style="color: var(--text-color);">{{ stats.pending_supply_orders }}</h3>
        <p class="text-xs mt-2" style="color: var(--text-muted);">
            {% if stats.pending_supply_orders == 0 %}
            <span class="text-green-500">No pending orders âœ“</span>
            {% else %}
            Pending restocks
            {% endif %}
        </p>
    </div>
</div>

<!-- Quick Actions -->
<div class="chart-card mb-8">
    <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Quick Actions</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <a href="{{ url_for('main.add_book') }}" class="quick-action-btn">
            <i class="fas fa-plus-circle text-blue-500"></i>
            <span>Add Book</span>
        </a>
        {% if current_user.is_admin() %}
        <a href="{{ url_for('main.members') }}" class="quick-action-btn">
            <i class="fas fa-user-plus text-green-500"></i>
            <span>New Member</span>
        </a>
        <a href="{{ url_for('main.add_campaign') }}" class="quick-action-btn">
            <i class="fas fa-bullhorn text-purple-500"></i>
            <span>New Campaign</span>
        </a>
        {% endif %}
        <a href="{{ url_for('main.supplier_shortlist') }}" class="quick-action-btn">
            <i class="fas fa-shopping-cart text-amber-500"></i>
            <span>New Order</span>
        </a>
    </div>
</div>

<!-- Alerts & Recent Activity Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Alerts Section -->
    <div>
        {% if stats.overdue_count > 0 or stats.stock_alerts_count > 0 %}
        <div class="chart-card h-full">
            <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">
                <i class="fas fa-exclamation-triangle text-amber-500 mr-2"></i>Alerts
            </h3>
            <div class="space-y-4">
                <!-- Overdue Loans -->
                {% if stats.overdue_count > 0 %}
                <div class="alert-card danger">
                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2" style="color: var(--text-color);">
                        <i class="fas fa-clock text-red-500"></i>
                        Overdue Loans ({{ stats.overdue_count }})
                    </h4>
                    <div class="space-y-2">
                        {% for loan in stats.overdue_loans %}
                        <div class="pl-3 border-l-2 border-red-300 dark:border-red-700">
                            <p class="font-semibold text-sm" style="color: var(--text-color);">{{ loan.book.title if
                                loan.book else 'Unknown' }}</p>
                            <p class="text-xs" style="color: var(--text-muted);">Borrowed by {{ loan.user.username if
                                loan.user else 'Unknown' }} â€¢ Due {{ loan.due_date.strftime('%Y-%m-%d') }}</p>
                        </div>
                        {% endfor %}
                        {% if stats.overdue_count > 5 %}
                        <a href="{{ url_for('main.admin_loans') }}" class="text-sm text-blue-500 hover:underline">View
                            all {{ stats.overdue_count }} overdue loans â†’</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Low Stock -->
                {% if stats.stock_alerts_count > 0 %}
                <div class="alert-card warning">
                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2" style="color: var(--text-color);">
                        <i class="fas fa-box-open text-amber-500"></i>
                        Low Stock Alerts ({{ stats.stock_alerts_count }})
                    </h4>
                    <div class="space-y-2">
                        {% for book in stats.low_stock_books %}
                        <div class="pl-3 border-l-2 border-amber-300 dark:border-amber-700">
                            <p class="font-semibold text-sm" style="color: var(--text-color);">{{ book.title }}</p>
                            <p class="text-xs" style="color: var(--text-muted);">Only {{ book.stock_available }} copies
                                available</p>
                        </div>
                        {% endfor %}
                        {% if stats.stock_alerts_count > 5 %}
                        <a href="{{ url_for('main.inventory') }}" class="text-sm text-blue-500 hover:underline">View all
                            {{ stats.stock_alerts_count }} low stock items â†’</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="chart-card h-full">
            <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>Alerts
            </h3>
            <p class="text-sm" style="color: var(--text-muted);">No alerts at this time. Everything is running smoothly!
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Recent Activity -->
    <div class="chart-card h-full">
        <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Recent Activity</h3>
        {% include 'admin/partials/_recent_activity.html' %}
    </div>
</div>

<!-- Sales Trend Chart (Full Width) -->
<div class="chart-card mb-8">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
        <h3 class="font-bold text-lg" style="color: var(--text-color);" id="salesTrendTitle">Sales Trend (Last 30 Days)
        </h3>
        <div class="flex p-1 rounded-xl border transition-colors w-full sm:w-auto"
            style="background-color: var(--pill-bg); border-color: var(--border-color);">
            <button onclick="updateSalesChart('daily')"
                class="sales-toggle-btn flex-1 sm:flex-none px-3 sm:px-4 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition-all active-toggle"
                id="daily-toggle" style="background-color: var(--primary-color); color: white;">Daily</button>
            <button onclick="updateSalesChart('monthly')"
                class="sales-toggle-btn flex-1 sm:flex-none px-3 sm:px-4 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition-all"
                id="monthly-toggle" style="color: var(--text-muted); background-color: transparent;">Monthly</button>
            <button onclick="updateSalesChart('yearly')"
                class="sales-toggle-btn flex-1 sm:flex-none px-3 sm:px-4 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition-all"
                id="yearly-toggle" style="color: var(--text-muted); background-color: transparent;">Yearly</button>
        </div>
    </div>
    <div class="chart-container relative" style="position: relative; height: 300px; width: 100%;">
        <canvas id="salesTrendChart"></canvas>
    </div>
</div>

<!-- Popular Books & Stock Distribution -->
<div class="grid grid-cols-1 gap-6 mb-8">
    <!-- Top Selling Books -->
    <div class="chart-card">
        <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Top Selling Books</h3>
        <div class="chart-container">
            <canvas id="topSellingBooksChart"></canvas>
        </div>
    </div>

    <!-- Stock by Category -->
    <div class="chart-card">
        <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Stock by Category</h3>
        <div class="chart-container">
            <canvas id="categoryStockChart"></canvas>
        </div>
    </div>
</div>

<!-- Management Team Section -->
<div class="chart-card mb-8" id="management-team-section">
    <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Management Team</h3>
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr>
                    <th class="p-3 border-b" style="border-color: var(--border-color);">Image</th>
                    <th class="p-3 border-b" style="border-color: var(--border-color);">Name</th>
                    <th class="p-3 border-b" style="border-color: var(--border-color);">Designation</th>
                    <th class="p-3 border-b" style="border-color: var(--border-color);">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for member in management_members %}
                <tr>
                    <td class="p-3 border-b" style="border-color: var(--border-color);">
                        {% if member.image_file.startswith('http') %}
                        <img src="{{ member.image_file }}" class="w-10 h-10 rounded-full object-cover">
                        {% else %}
                        <img src="{{ url_for('static', filename=member.image_file) }}"
                            class="w-10 h-10 rounded-full object-cover">
                        {% endif %}
                    </td>
                    <td class="p-3 border-b" style="border-color: var(--border-color);">{{ member.name }}</td>
                    <td class="p-3 border-b" style="border-color: var(--border-color);">{{ member.designation }}</td>
                    <td class="p-3 border-b" style="border-color: var(--border-color);">
                        {% if current_user.is_admin() %}
                        <button
                            onclick="openEditManagementModal('{{ member.id }}', '{{ member.name }}', '{{ member.designation }}')"
                            class="text-blue-500 hover:text-blue-700">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Management Modal -->
<div id="editManagementModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
    style="background-color: rgba(0, 0, 0, 0.5);">
    <div class="rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
        style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
        <!-- Modal Header -->
        <div class="sticky top-0 px-6 py-4 border-b"
            style="background-color: var(--card-bg); border-color: var(--border-color);">
            <div class="flex items-center justify-between">
                <h3 class="text-2xl font-bold" style="color: var(--text-color);">
                    <i class="fas fa-user-edit mr-2" style="color: var(--primary-color);"></i>
                    Edit Team Member
                </h3>
                <button type="button" onclick="closeEditManagementModal()"
                    class="p-2 rounded-lg transition-colors hover:bg-opacity-10"
                    style="color: var(--text-muted); background-color: transparent;"
                    onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                    onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <form action="{{ url_for('main.update_management_member') }}" method="POST" enctype="multipart/form-data">
            <div class="p-6 space-y-6">
                <input type="hidden" name="id" id="editMemberId">

                <!-- Name Field -->
                <div>
                    <label class="block text-sm font-semibold mb-2" style="color: var(--text-color);">
                        <i class="fas fa-user mr-2" style="color: var(--primary-color);"></i>
                        Full Name
                    </label>
                    <input type="text" name="name" id="editMemberName" required
                        class="w-full px-4 py-3 border rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-blue-500"
                        style="background-color: var(--input-bg); border-color: var(--border-color); color: var(--text-color);"
                        placeholder="Enter full name">
                </div>

                <!-- Designation Field -->
                <div>
                    <label class="block text-sm font-semibold mb-2" style="color: var(--text-color);">
                        <i class="fas fa-briefcase mr-2" style="color: var(--primary-color);"></i>
                        Designation
                    </label>
                    <input type="text" name="designation" id="editMemberDesignation" required
                        class="w-full px-4 py-3 border rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-blue-500"
                        style="background-color: var(--input-bg); border-color: var(--border-color); color: var(--text-color);"
                        placeholder="e.g., Chief Librarian">
                </div>

                <!-- Profile Image Field -->
                <div>
                    <label class="block text-sm font-semibold mb-2" style="color: var(--text-color);">
                        <i class="fas fa-image mr-2" style="color: var(--primary-color);"></i>
                        Profile Image
                    </label>
                    <div class="border-2 border-dashed rounded-lg p-4 transition-colors"
                        style="border-color: var(--border-color);">
                        <input type="file" name="image" id="editMemberImage" accept="image/*" class="w-full text-sm"
                            style="color: var(--text-color);">
                        <p class="text-xs mt-2 flex items-center gap-1" style="color: var(--text-muted);">
                            <i class="fas fa-info-circle"></i>
                            Leave empty to keep the current image. Recommended: Square image, at least 200x200px
                        </p>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="sticky bottom-0 px-6 py-4 border-t flex justify-end gap-3"
                style="background-color: var(--card-bg); border-color: var(--border-color);">
                <button type="button" onclick="closeEditManagementModal()"
                    class="px-6 py-2.5 border rounded-lg font-semibold transition-all"
                    style="color: var(--text-color); border-color: var(--border-color); background-color: transparent;"
                    onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                    onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-semibold transition-all hover:bg-blue-700 hover:shadow-lg">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function openEditManagementModal(id, name, designation) {
        document.getElementById('editMemberId').value = id;
        document.getElementById('editMemberName').value = name;
        document.getElementById('editMemberDesignation').value = designation;
        document.getElementById('editMemberImage').value = ''; // Clear file input

        const modal = document.getElementById('editManagementModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeEditManagementModal() {
        const modal = document.getElementById('editManagementModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = ''; // Restore scrolling
    }

    // Close modal when clicking outside
    document.getElementById('editManagementModal')?.addEventListener('click', function (e) {
        if (e.target === this) {
            closeEditManagementModal();
        }});

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('editManagementModal');
            if (modal && !modal.classList.contains('hidden')) {
                closeEditManagementModal();
            }}
    });
</script>

<!-- Stat Modals -->

<!-- Customer Orders Modal -->
<div id="customerOrdersModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
    style="background-color: rgba(0, 0, 0, 0.5);">
    <div class="rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto"
        style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
        <!-- Modal Header -->
        <div class="sticky top-0 px-6 py-4 border-b"
            style="background-color: var(--card-bg); border-color: var(--border-color);">
            <div class="flex items-center justify-between">
                <h3 class="text-2xl font-bold" style="color: var(--text-color);">
                    <i class="fas fa-shopping-bag mr-2 text-blue-600"></i>
                    Pending Customer Orders ({{ stats.pending_customer_orders }})
                </h3>
                <button type="button" onclick="closeStatModal('customerOrdersModal')"
                    class="p-2 rounded-lg transition-colors" style="color: var(--text-muted);"
                    onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                    onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="p-6">
            {% if stats.all_pending_customer_orders %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b" style="border-color: var(--border-color);">
                            <th class="text-left p-3" style="color: var(--text-color);">Book</th>
                            <th class="text-left p-3" style="color: var(--text-color);">Customer</th>
                            <th class="text-left p-3" style="color: var(--text-color);">Order Date</th>
                            <th class="text-left p-3" style="color: var(--text-color);">Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in stats.all_pending_customer_orders[:10] %}
                        <tr class="border-b hover:bg-opacity-5 hover:bg-gray-500 transition-colors"
                            style="border-color: var(--border-color);">
                            <td class="p-3">
                                <p class="font-semibold" style="color: var(--text-color);">{{ sale.book.title if
                                    sale.book else 'Unknown' }}</p>
                            </td>
                            <td class="p-3" style="color: var(--text-color);">{{ sale.user.username if sale.user else
                                'Unknown' }}</td>
                            <td class="p-3 text-sm" style="color: var(--text-muted);">{{
                                sale.sale_date.strftime('%Y-%m-%d') }}</td>
                            <td class="p-3 font-bold" style="color: var(--text-color);">{{ sale.price_at_sale }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if stats.all_pending_customer_orders|length > 10 %}
            <p class="text-center mt-4 text-sm" style="color: var(--text-muted);">
                Showing 10 of {{ stats.all_pending_customer_orders|length }} pending orders. <a
                    href="{{ url_for('main.admin_sales') }}" class="text-blue-600 hover:underline">View all â†’</a>
            </p>
            {% endif %}
            {% else %}
            <p class="text-center py-8" style="color: var(--text-muted);">No pending customer orders found.</p>
            {% endif %}
        </div>

        <!-- Modal Footer -->
        <div class="sticky bottom-0 px-6 py-4 border-t flex justify-between items-center"
            style="background-color: var(--card-bg); border-color: var(--border-color);">
            <a href="{{ url_for('main.admin_sales') }}" class="text-blue-600 hover:text-blue-700 font-semibold">
                <i class="fas fa-external-link-alt mr-2"></i>View Full Orders Management
            </a>
            <button type="button" onclick="closeStatModal('customerOrdersModal')"
                class="px-6 py-2.5 border rounded-lg font-semibold transition-all"
                style="color: var(--text-color); border-color: var(--border-color);"
                onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                onmouseout="this.style.backgroundColor='transparent'">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Total Books Modal -->
<div id="booksModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
    style="background-color: rgba(0, 0, 0, 0.5);">
    <div class="rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto"
        style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
        <!-- Modal Header -->
        <div class="sticky top-0 px-6 py-4 border-b"
            style="background-color: var(--card-bg); border-color: var(--border-color);">
            <div class="flex items-center justify-between">
                <h3 class="text-2xl font-bold" style="color: var(--text-color);">
                    <i class="fas fa-book mr-2 text-purple-600"></i>
                    Book Inventory ({{ stats.total_books }} Books)
                </h3>
                <button type="button" onclick="closeStatModal('booksModal')" class="p-2 rounded-lg transition-colors"
                    style="color: var(--text-muted);" onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                    onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-6">
            <!-- Category Breakdown -->
            <div>
                <h4 class="text-lg font-semibold mb-4" style="color: var(--text-color);">
                    <i class="fas fa-chart-pie mr-2"></i>Stock by Category
                </h4>
                {% if stats.category_data %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                    {% for cat in stats.category_data[:8] %}
                    <div class="p-3 md:p-4 rounded-lg border"
                        style="background-color: var(--card-bg); border-color: var(--border-color);">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-sm md:text-base" style="color: var(--text-color);">{{
                                cat.category }}</span>
                            <span
                                class="px-2 md:px-3 py-1 rounded-full bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-200 font-bold text-sm">
                                {{ cat.stock }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if stats.category_data|length > 8 %}
                <p class="text-sm mt-3" style="color: var(--text-muted);">
                    Showing 8 of {{ stats.category_data|length }} categories. <a href="{{ url_for('main.inventory') }}"
                        class="text-blue-600 hover:underline">View all â†’</a>
                </p>
                {% endif %}
                {% else %}
                <p style="color: var(--text-muted);">No category data available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="sticky bottom-0 px-6 py-4 border-t flex justify-between items-center"
            style="background-color: var(--card-bg); border-color: var(--border-color);">
            <a href="{{ url_for('main.inventory') }}" class="text-blue-600 hover:text-blue-700 font-semibold">
                <i class="fas fa-external-link-alt mr-2"></i>View Full Inventory
            </a>
            <button type="button" onclick="closeStatModal('booksModal')"
                class="px-6 py-2.5 border rounded-lg font-semibold transition-all"
                style="color: var(--text-color); border-color: var(--border-color);"
                onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                onmouseout="this.style.backgroundColor='transparent'">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Active Loans Modal -->
<div id="loansModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
    style="background-color: rgba(0, 0, 0, 0.5);">
    <div class="rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto"
        style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
        <!-- Modal Header -->
        <div class="sticky top-0 px-6 py-4 border-b"
            style="background-color: var(--card-bg); border-color: var(--border-color);">
            <div class="flex items-center justify-between">
                <h3 class="text-2xl font-bold" style="color: var(--text-color);">
                    <i class="fas fa-hand-holding-heart mr-2 text-amber-600"></i>
                    Active Loans ({{ stats.active_loans }})
                </h3>
                <button type="button" onclick="closeStatModal('loansModal')" class="p-2 rounded-lg transition-colors"
                    style="color: var(--text-muted);" onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                    onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="p-6">
            {% if stats.all_active_loans %}

            <!-- Mobile Card View -->
            <div class="md:hidden space-y-3">
                {% for loan in stats.all_active_loans[:5] %}
                <div class="p-3 rounded-lg border"
                    style="background-color: var(--card-bg); border-color: var(--border-color);">
                    <div class="space-y-2">
                        <div>
                            <p class="text-xs font-semibold uppercase" style="color: var(--text-muted);">Book</p>
                            <p class="font-semibold" style="color: var(--text-color);">{{ loan.book.title if loan.book
                                else 'Unknown' }}</p>
                        </div>
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-1">
                                <p class="text-xs font-semibold uppercase" style="color: var(--text-muted);">Borrower
                                </p>
                                <p class="text-sm" style="color: var(--text-color);">{{ loan.user.username if loan.user
                                    else 'Unknown' }}</p>
                            </div>
                            <div>
                                {% if loan.due_date and loan.due_date < stats.current_datetime %} <span
                                    class="px-2 py-1 rounded bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200 text-xs font-semibold whitespace-nowrap">
                                    <i class="fas fa-exclamation-circle mr-1"></i>Overdue
                                    </span>
                                    {% else %}
                                    <span
                                        class="px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200 text-xs font-semibold whitespace-nowrap">
                                        <i class="fas fa-check-circle mr-1"></i>On Time
                                    </span>
                                    {% endif %}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <p class="text-xs font-semibold uppercase" style="color: var(--text-muted);">Checkout
                                </p>
                                <p class="text-sm" style="color: var(--text-color);">{{
                                    loan.checkout_date.strftime('%Y-%m-%d') if loan.checkout_date else 'N/A' }}</p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase" style="color: var(--text-muted);">Due Date
                                </p>
                                <p class="text-sm" style="color: var(--text-color);">{{
                                    loan.due_date.strftime('%Y-%m-%d') if loan.due_date else 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Desktop Table View -->
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b" style="border-color: var(--border-color);">
                            <th class="text-left p-3" style="color: var(--text-color);">Book</th>
                            <th class="text-left p-3" style="color: var(--text-color);">Borrower</th>
                            <th class="text-left p-3" style="color: var(--text-color);">Checkout Date</th>
                            <th class="text-left p-3" style="color: var(--text-color);">Due Date</th>
                            <th class="text-left p-3" style="color: var(--text-color);">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for loan in stats.all_active_loans[:5] %}
                        <tr class="border-b hover:bg-opacity-5 hover:bg-gray-500 transition-colors"
                            style="border-color: var(--border-color);">
                            <td class="p-3">
                                <p class="font-semibold" style="color: var(--text-color);">{{ loan.book.title if
                                    loan.book else 'Unknown' }}</p>
                            </td>
                            <td class="p-3" style="color: var(--text-color);">{{ loan.user.username if loan.user else
                                'Unknown' }}</td>
                            <td class="p-3 text-sm" style="color: var(--text-muted);">{{
                                loan.checkout_date.strftime('%Y-%m-%d') if loan.checkout_date else 'N/A' }}</td>
                            <td class="p-3 text-sm" style="color: var(--text-muted);">{{
                                loan.due_date.strftime('%Y-%m-%d') if loan.due_date else 'N/A' }}</td>
                            <td class="p-3">
                                {% if loan.due_date and loan.due_date < stats.current_datetime %} <span
                                    class="px-2 py-1 rounded bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200 text-xs font-semibold">
                                    <i class="fas fa-exclamation-circle mr-1"></i>Overdue
                                    </span>
                                    {% else %}
                                    <span
                                        class="px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200 text-xs font-semibold">
                                        <i class="fas fa-check-circle mr-1"></i>On Time
                                    </span>
                                    {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if stats.all_active_loans|length > 5 %}
            <p class="text-center mt-4 text-sm" style="color: var(--text-muted);">
                Showing 5 of {{ stats.all_active_loans|length }} active loans. <a
                    href="{{ url_for('main.admin_loans') }}" class="text-blue-600 hover:underline">View all â†’</a>
            </p>
            {% endif %}
            {% else %}
            <p class="text-center py-8" style="color: var(--text-muted);">No active loans.</p>
            {% endif %}
        </div>

        <!-- Modal Footer -->
        <div class="sticky bottom-0 px-6 py-4 border-t flex justify-between items-center"
            style="background-color: var(--card-bg); border-color: var(--border-color);">
            <a href="{{ url_for('main.admin_loans') }}" class="text-blue-600 hover:text-blue-700 font-semibold">
                <i class="fas fa-external-link-alt mr-2"></i>View Full Loans Page
            </a>
            <button type="button" onclick="closeStatModal('loansModal')"
                class="px-6 py-2.5 border rounded-lg font-semibold transition-all"
                style="color: var(--text-color); border-color: var(--border-color);"
                onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                onmouseout="this.style.backgroundColor='transparent'">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Pending Orders Modal -->
<div id="ordersModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
    style="background-color: rgba(0, 0, 0, 0.5);">
    <div class="rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto"
        style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
        <!-- Modal Header -->
        <div class="sticky top-0 px-6 py-4 border-b"
            style="background-color: var(--card-bg); border-color: var(--border-color);">
            <div class="flex items-center justify-between">
                <h3 class="text-2xl font-bold" style="color: var(--text-color);">
                    <i class="fas fa-truck-loading mr-2 text-emerald-600"></i>
                    Supply Orders ({{ stats.pending_supply_orders }})
                </h3>
                <button type="button" onclick="closeStatModal('ordersModal')" class="p-2 rounded-lg transition-colors"
                    style="color: var(--text-muted);" onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                    onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="p-6">
            {% if stats.all_pending_orders %}
            <div class="space-y-2">
                {% for order in stats.all_pending_orders[:5] %}
                <div class="p-3 rounded-lg border hover:shadow-md transition-shadow"
                    style="background-color: var(--card-bg); border-color: var(--border-color);">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-4 flex-1">
                            <div>
                                <p class="font-semibold" style="color: var(--text-color);">Order #{{ order.id }}</p>
                                <p class="text-xs" style="color: var(--text-muted);">
                                    {{ order.created_at.strftime('%Y-%m-%d %H:%M') if order.created_at else 'N/A' }}
                                </p>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap
                            {% if order.status == 'shortlist' %}bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200
                            {% elif order.status == 'pending_review' %}bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-200
                            {% elif order.status == 'placed' %}bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200
                            {% endif %}">
                            {{ order.status.replace('_', ' ').title() }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if stats.all_pending_orders|length > 5 %}
            <p class="text-center mt-4 text-sm" style="color: var(--text-muted);">
                Showing 5 of {{ stats.all_pending_orders|length }} pending orders. <a
                    href="{{ url_for('main.supplier_review') }}" class="text-blue-600 hover:underline">View all â†’</a>
            </p>
            {% endif %}
            {% else %}
            <p class="text-center py-8" style="color: var(--text-muted);">No pending orders.</p>
            {% endif %}
        </div>

        <!-- Modal Footer -->
        <div class="sticky bottom-0 px-6 py-4 border-t flex justify-between items-center"
            style="background-color: var(--card-bg); border-color: var(--border-color);">
            <a href="{{ url_for('main.supplier_review') }}" class="text-blue-600 hover:text-blue-700 font-semibold">
                <i class="fas fa-external-link-alt mr-2"></i>View Full Orders Page
            </a>
            <button type="button" onclick="closeStatModal('ordersModal')"
                class="px-6 py-2.5 border rounded-lg font-semibold transition-all"
                style="color: var(--text-color); border-color: var(--border-color);"
                onmouseover="this.style.backgroundColor='rgba(128,128,128,0.1)'"
                onmouseout="this.style.backgroundColor='transparent'">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Stat Modal JavaScript -->
<script>
    function openStatModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }}

    function closeStatModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
        }}

    // Close modal when clicking outside
    ['membersModal', 'booksModal', 'loansModal', 'ordersModal'].forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeStatModal(modalId);
                }});
        }});

    // Update Escape key handler to close all stat modals
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            // Close management modal
            const mgmtModal = document.getElementById('editManagementModal');
            if (mgmtModal && !mgmtModal.classList.contains('hidden')) {
                closeEditManagementModal();
                return;
            }

            // Close any open stat modal
            ['membersModal', 'booksModal', 'loansModal', 'ordersModal'].forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && !modal.classList.contains('hidden')) {
                    closeStatModal(modalId);
                }});
        }});
</script>

<script>
    // Chart.js Configuration
    const chartColors = {
        primary: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#6366f1',
        blue: '#3b82f6',
        purple: '#a855f7',
        amber: '#f59e0b',
        green: '#22c55e',
        red: '#ef4444',
        cyan: '#06b6d4',
        pink: '#ec4899',
        indigo: '#6366f1',
        teal: '#14b8a6',
        orange: '#f97316',
        lime: '#84cc16',
        rose: '#f43f5e',
        emerald: '#10b981',
        violet: '#8b5cf6'
    };

    // Create a color palette array for charts with many categories
    const categoryColorPalette = [
        chartColors.blue,
        chartColors.purple,
        chartColors.amber,
        chartColors.green,
        chartColors.red,
        chartColors.cyan,
        chartColors.pink,
        chartColors.indigo,
        chartColors.teal,
        chartColors.orange,
        chartColors.lime,
        chartColors.rose,
        chartColors.emerald,
        chartColors.violet
    ];

    // Sales Trend Logic
    let salesChart = null;
    const salesData = {
        daily: {
            labels: {{ stats.sales_trends.daily | map(attribute='label') | list | tojson }},
    data: {{ stats.sales_trends.daily | map(attribute='count') | list | tojson }},
    title: 'Sales Trend (Last 30 Days)'
        },
    monthly: {
        labels: {{ stats.sales_trends.monthly | map(attribute='label') | list | tojson }},
        data: {{ stats.sales_trends.monthly | map(attribute='count') | list | tojson }},
        title: 'Sales Trend (Last 12 Months)'
    },
    yearly: {
        labels: {{ stats.sales_trends.yearly | map(attribute='label') | list | tojson }},
        data: {{ stats.sales_trends.yearly | map(attribute='count') | list | tojson }},
        title: 'Sales Trend (Last 5 Years)'
    }};

    function updateSalesChart(period) {
        // Update Title
        document.getElementById('salesTrendTitle').innerText = salesData[period].title;

        // Update Button Styles
        document.querySelectorAll('.sales-toggle-btn').forEach(btn => {
            btn.style.backgroundColor = 'transparent';
            btn.style.color = 'var(--text-muted)';
        });
        const activeBtn = document.getElementById(period + '-toggle');
        activeBtn.style.backgroundColor = 'var(--primary-color)';
        activeBtn.style.color = 'white';

        // Update Chart
        if (salesChart) {
            salesChart.data.labels = salesData[period].labels;
            salesChart.data.datasets[0].data = salesData[period].data;
            salesChart.update();
        }}

    // Initialize Charts
    function initDashboardCharts() {
        // Sales Trend Chart
        const salesCtx = document.getElementById('salesTrendChart').getContext('2d');
        if (salesChart) salesChart.destroy();

        salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: salesData.daily.labels,
                datasets: [{
                    label: 'Books Sold',
                    data: salesData.daily.data,
                    borderColor: chartColors.green,
                    backgroundColor: chartColors.green + '20',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }},
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }}
                }}
        });

        // Top Selling Books Chart
        const topSellingCtx = document.getElementById('topSellingBooksChart').getContext('2d');
        new Chart(topSellingCtx, {
            type: 'bar',
            data: {
                labels: {{ stats.top_selling_books | map(attribute='title') | list | tojson }},
    datasets: [{
        label: 'Copies Sold',
        data: {{ stats.top_selling_books | map(attribute='count') | list | tojson }},
        backgroundColor: [chartColors.blue, chartColors.purple, chartColors.amber, chartColors.green, chartColors.red]
                }]
            },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: { display: false }},
        scales: {
            y: { beginAtZero: true }}
    }});

    // Category Stock Chart
    const categoryCtx = document.getElementById('categoryStockChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: {{ stats.category_data | map(attribute='category') | list | tojson }},
        datasets: [{
            data: {{ stats.category_data | map(attribute='stock') | list | tojson }},
        backgroundColor: categoryColorPalette
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false
    }});
}

    // Call init on load and on HTMX content load
    initDashboardCharts();
    document.body.addEventListener('htmx:afterOnLoad', function (evt) {
        if (evt.detail.target.id === 'mainContent') {
            // Re-init charts if dashboard was loaded
            if (document.getElementById('salesTrendChart')) {
                initDashboardCharts();
            }}
    });
</script>
{% endblock %}