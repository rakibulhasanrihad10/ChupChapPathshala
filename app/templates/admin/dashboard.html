{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}
{% block container_class %}{% endblock %}

{% block head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Dashboard CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<!-- Mobile Hamburger -->
<button class="mobile-hamburger" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- Sidebar -->
<aside class="dashboard-sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="fas fa-book-open"></i>
            <span class="sidebar-text ml-2">ChupChap</span>
        </div>
        <button class="sidebar-toggle" onclick="toggleSidebarCollapse()">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <nav class="sidebar-nav">
        <!-- Dashboard -->
        <div class="sidebar-section">
            <a href="{{ url_for('main.admin_dashboard') }}" class="sidebar-link active tooltip" data-tooltip="Dashboard"
                aria-label="Dashboard" aria-current="page">
                <span class="sidebar-icon"><i class="fas fa-th-large"></i></span>
                <span class="sidebar-text">Dashboard</span>
            </a>
        </div>

        <!-- Administration -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Administration</div>
            {% if current_user.is_admin() %}
            <a href="{{ url_for('main.members') }}" class="sidebar-link tooltip" data-tooltip="Members"
                aria-label="Manage library members">
                <span class="sidebar-icon"><i class="fas fa-users"></i></span>
                <span class="sidebar-text">Members</span>
            </a>
            {% endif %}
            <a href="{{ url_for('main.admin_loans') }}" class="sidebar-link tooltip" data-tooltip="Borrowed Books"
                aria-label="Manage borrowed books and loans">
                <span class="sidebar-icon"><i class="fas fa-book-reader"></i></span>
                <span class="sidebar-text">Borrowed Books</span>
            </a>
            <a href="{{ url_for('main.inventory') }}" class="sidebar-link tooltip" data-tooltip="Inventory"
                aria-label="Manage book inventory and stock">
                <span class="sidebar-icon"><i class="fas fa-boxes"></i></span>
                <span class="sidebar-text">Inventory</span>
            </a>
        </div>

        <!-- Marketing -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Marketing</div>
            <a href="{{ url_for('main.admin_offers') }}" class="sidebar-link tooltip" data-tooltip="Manage Offers"
                aria-label="Manage discounts and offers">
                <span class="sidebar-icon"><i class="fas fa-tags"></i></span>
                <span class="sidebar-text">Manage Offers</span>
            </a>
            <a href="{{ url_for('main.admin_campaigns') }}" class="sidebar-link tooltip" data-tooltip="Campaigns"
                aria-label="Manage marketing campaigns">
                <span class="sidebar-icon"><i class="fas fa-bullhorn"></i></span>
                <span class="sidebar-text">Campaigns</span>
            </a>
        </div>

        <!-- Supply Chain -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Supply Chain</div>
            {% if current_user.is_admin() %}
            <a href="{{ url_for('main.supplier_review') }}" class="sidebar-link tooltip" data-tooltip="Review Orders"
                aria-label="Review and approve supply orders">
                <span class="sidebar-icon"><i class="fas fa-clipboard-check"></i></span>
                <span class="sidebar-text">Review Orders</span>
            </a>
            {% endif %}
            <a href="{{ url_for('main.supplier_orders') }}" class="sidebar-link tooltip" data-tooltip="Track Orders"
                aria-label="Track supply orders">
                <span class="sidebar-icon"><i class="fas fa-search-location"></i></span>
                <span class="sidebar-text">Track Orders</span>
            </a>
            <a href="{{ url_for('main.supplier_shortlist') }}" class="sidebar-link tooltip" data-tooltip="Shortlist"
                aria-label="Manage supply order shortlist">
                <span class="sidebar-icon"><i class="fas fa-list-ol"></i></span>
                <span class="sidebar-text">Shortlist</span>
            </a>
            <a href="{{ url_for('main.supplier_receive_list') }}" class="sidebar-link tooltip" data-tooltip="Received"
                aria-label="View received supply orders">
                <span class="sidebar-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                <span class="sidebar-text">Received</span>
            </a>
        </div>
    </nav>

    <div class="sidebar-footer">
        <a href="{{ url_for('main.index') }}" class="sidebar-link">
            <span class="sidebar-icon"><i class="fas fa-home"></i></span>
            <span class="sidebar-text">Back to Site</span>
        </a>
    </div>
</aside>

<!-- Main Content -->
<main class="dashboard-main" id="mainContent">
    <!-- Dashboard Header -->
    <div class="dashboard-header" style="padding: 1rem 1.5rem;">
        <div class="flex items-center justify-between gap-4">
            <!-- Search Bar -->
            <div class="flex-1 max-w-xl relative">
                <div class="relative">
                    <input type="text" id="globalSearch" placeholder="Search books, members, orders... (Ctrl+K)"
                        class="w-full px-4 py-2 pl-10 pr-4 rounded-lg border transition-all focus:outline-none focus:ring-2 focus:ring-blue-500"
                        style="background-color: var(--bg-color); border-color: var(--border-color); color: var(--text-color);"
                        aria-label="Global search">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 opacity-50"></i>
                </div>
            </div>

            <!-- Right Side Actions -->
            <div class="flex items-center gap-4">
                <!-- Notifications -->
                <div class="relative">
                    <button class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors relative"
                        aria-label="Notifications">
                        <i class="fas fa-bell text-xl" style="color: var(--text-color);"></i>
                        {% if stats.overdue_count > 0 or stats.stock_alerts_count > 0 %}
                        <span
                            class="absolute top-0 right-0 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold">
                            {{ stats.overdue_count + stats.stock_alerts_count }}
                        </span>
                        {% endif %}
                    </button>
                </div>

                <!-- User Profile -->
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold">
                        {{ current_user.username[0].upper() }}
                    </div>
                    <span class="text-sm font-semibold hidden md:block" style="color: var(--text-color);">{{
                        current_user.username }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-extrabold tracking-tight mb-2" style="color: var(--text-color);">Dashboard Overview
            </h1>
            <p style="color: var(--text-muted);">Welcome back! Here's what's happening with your library today.</p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Members -->
            <div class="stat-card rounded-2xl p-6 shadow-lg border transition-all hover:scale-105 hover:shadow-2xl"
                style="background-color: var(--card-bg); border-color: var(--border-color); border-left: 4px solid #3b82f6;">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-3 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600">
                        <i class="fas fa-users text-2xl"></i>
                    </div>
                    {% if stats.user_trend.direction != 'neutral' %}
                    <span class="trend-indicator {{ stats.user_trend.direction }}">
                        <i class="fas fa-arrow-{{ 'up' if stats.user_trend.direction == 'up' else 'down' }}"></i>
                        {{ stats.user_trend.percentage }}%
                    </span>
                    {% endif %}
                </div>
                <p class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Total
                    Members</p>
                <h3 class="text-3xl font-bold" style="color: var(--text-color);">{{ stats.total_users }}</h3>
                <p class="text-xs mt-2" style="color: var(--text-muted);">
                    {% if stats.total_users == 0 %}
                    <span class="text-amber-500">No members yet!</span>
                    {% else %}
                    Active members
                    {% endif %}
                </p>
            </div>

            <!-- Total Books -->
            <div class="stat-card rounded-2xl p-6 shadow-lg border transition-all hover:scale-105 hover:shadow-2xl"
                style="background-color: var(--card-bg); border-color: var(--border-color); border-left: 4px solid #a855f7;">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-3 rounded-xl bg-gradient-to-br from-purple-100 to-purple-200 text-purple-600">
                        <i class="fas fa-book text-2xl"></i>
                    </div>
                </div>
                <p class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Total Books
                </p>
                <h3 class="text-3xl font-bold" style="color: var(--text-color);">{{ stats.total_books }}</h3>
                <p class="text-xs mt-2" style="color: var(--text-muted);">
                    {% if stats.total_books == 0 %}
                    <span class="text-amber-500">Catalog is empty!</span>
                    {% else %}
                    In collection
                    {% endif %}
                </p>
            </div>

            <!-- Active Loans -->
            <div class="stat-card rounded-2xl p-6 shadow-lg border transition-all hover:scale-105 hover:shadow-2xl"
                style="background-color: var(--card-bg); border-color: var(--border-color); border-left: 4px solid #f59e0b;">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-3 rounded-xl bg-gradient-to-br from-amber-100 to-amber-200 text-amber-600">
                        <i class="fas fa-hand-holding-heart text-2xl"></i>
                    </div>
                </div>
                <p class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Active
                    Loans</p>
                <h3 class="text-3xl font-bold" style="color: var(--text-color);">{{ stats.active_loans }}</h3>
                {% if stats.overdue_count > 0 %}
                <p class="text-xs mt-2 flex items-center gap-1">
                    <i class="fas fa-exclamation-circle text-red-500"></i>
                    <span class="text-red-500 font-semibold">{{ stats.overdue_count }} overdue</span>
                </p>
                {% else %}
                <p class="text-xs mt-2" style="color: var(--text-muted);">
                    {% if stats.active_loans == 0 %}
                    <span class="text-green-500">All books available! ðŸ“š</span>
                    {% else %}
                    <span class="text-green-500">All on time âœ“</span>
                    {% endif %}
                </p>
                {% endif %}
            </div>

            <!-- Pending Orders -->
            <div class="stat-card rounded-2xl p-6 shadow-lg border transition-all hover:scale-105 hover:shadow-2xl"
                style="background-color: var(--card-bg); border-color: var(--border-color); border-left: 4px solid #22c55e;">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-3 rounded-xl bg-gradient-to-br from-emerald-100 to-emerald-200 text-emerald-600">
                        <i class="fas fa-truck-loading text-2xl"></i>
                    </div>
                </div>
                <p class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Pending
                    Orders</p>
                <h3 class="text-3xl font-bold" style="color: var(--text-color);">{{ stats.pending_supply_orders }}</h3>
                <p class="text-xs mt-2" style="color: var(--text-muted);">
                    {% if stats.pending_supply_orders == 0 %}
                    <span class="text-green-500">No pending orders âœ“</span>
                    {% else %}
                    Awaiting processing
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="chart-card mb-8">
            <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Quick Actions</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="{{ url_for('main.add_book') }}" class="quick-action-btn">
                    <i class="fas fa-plus-circle text-blue-500"></i>
                    <span>Add Book</span>
                </a>
                {% if current_user.is_admin() %}
                <a href="{{ url_for('main.members') }}" class="quick-action-btn">
                    <i class="fas fa-user-plus text-green-500"></i>
                    <span>New Member</span>
                </a>
                <a href="{{ url_for('main.add_campaign') }}" class="quick-action-btn">
                    <i class="fas fa-bullhorn text-purple-500"></i>
                    <span>New Campaign</span>
                </a>
                {% endif %}
                <a href="{{ url_for('main.supplier_shortlist') }}" class="quick-action-btn">
                    <i class="fas fa-shopping-cart text-amber-500"></i>
                    <span>New Order</span>
                </a>
            </div>
        </div>

        <!-- Alerts Section -->
        {% if stats.overdue_count > 0 or stats.stock_alerts_count > 0 %}
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4" style="color: var(--text-color);">
                <i class="fas fa-exclamation-triangle text-amber-500 mr-2"></i>Alerts
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Overdue Loans -->
                {% if stats.overdue_count > 0 %}
                <div class="chart-card">
                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2" style="color: var(--text-color);">
                        <i class="fas fa-clock text-red-500"></i>
                        Overdue Loans ({{ stats.overdue_count }})
                    </h3>
                    <div class="space-y-2">
                        {% for loan in stats.overdue_loans %}
                        <div class="alert-card danger">
                            <p class="font-semibold text-sm" style="color: var(--text-color);">{{ loan.book.title if
                                loan.book else 'Unknown' }}</p>
                            <p class="text-xs" style="color: var(--text-muted);">Borrowed by {{ loan.user.username if
                                loan.user else 'Unknown' }} â€¢ Due {{ loan.due_date.strftime('%Y-%m-%d') }}</p>
                        </div>
                        {% endfor %}
                        {% if stats.overdue_count > 5 %}
                        <a href="{{ url_for('main.admin_loans') }}" class="text-sm text-blue-500 hover:underline">View
                            all {{ stats.overdue_count }} overdue loans â†’</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Low Stock -->
                {% if stats.stock_alerts_count > 0 %}
                <div class="chart-card">
                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2" style="color: var(--text-color);">
                        <i class="fas fa-box-open text-amber-500"></i>
                        Low Stock Alerts ({{ stats.stock_alerts_count }})
                    </h3>
                    <div class="space-y-2">
                        {% for book in stats.low_stock_books %}
                        <div class="alert-card warning">
                            <p class="font-semibold text-sm" style="color: var(--text-color);">{{ book.title }}</p>
                            <p class="text-xs" style="color: var(--text-muted);">Only {{ book.stock_available }} copies
                                available</p>
                        </div>
                        {% endfor %}
                        {% if stats.stock_alerts_count > 5 %}
                        <a href="{{ url_for('main.inventory') }}" class="text-sm text-blue-500 hover:underline">View all
                            {{ stats.stock_alerts_count }} low stock items â†’</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Charts & Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Sales Trend Chart -->
            <div class="lg:col-span-2 chart-card">
                <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Sales Trend (Last 30 Days)</h3>
                <div class="chart-container">
                    <canvas id="salesTrendChart"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="chart-card">
                <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Recent Activity</h3>
                <div class="space-y-2 max-h-[300px] overflow-y-auto">
                    {% for activity in stats.recent_activity %}
                    <div class="activity-item">
                        <div class="activity-icon {{ activity.color }}">
                            <i class="fas {{ activity.icon }}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-semibold" style="color: var(--text-color);">{{ activity.user }}</p>
                            <p class="text-xs" style="color: var(--text-muted);">
                                {{ 'Borrowed' if activity.type == 'borrow' else 'Returned' }} "{{ activity.book }}"
                            </p>
                            <p class="text-xs" style="color: var(--text-muted);">{{ activity.date.strftime('%b %d, %I:%M
                                %p') }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Popular Books & Stock Distribution -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Top Selling Books -->
            <div class="chart-card">
                <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Top Selling Books</h3>
                <div class="chart-container">
                    <canvas id="topSellingBooksChart"></canvas>
                </div>
            </div>

            <!-- Stock by Category -->
            <div class="chart-card">
                <h3 class="font-bold text-lg mb-4" style="color: var(--text-color);">Stock by Category</h3>
                <div class="chart-container">
                    <canvas id="categoryStockChart"></canvas>
                </div>
            </div>
        </div>


    </div>
</main>

<script>
    // Sidebar Toggle Functions
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('mobile-open');
    }

    function toggleSidebarCollapse() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('sidebar-collapsed');
    }

    // Chart.js Configuration
    const chartColors = {
        primary: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#6366f1',
        blue: '#3b82f6',
        purple: '#a855f7',
        amber: '#f59e0b',
        green: '#22c55e',
        red: '#ef4444'
    };

    // Sales Trend Chart
    const salesCtx = document.getElementById('salesTrendChart').getContext('2d');
    new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: {{ stats.sales_trend | map(attribute = 'date') | list | tojson }},
        datasets: [{
            label: 'Books Sold',
            data: {{ stats.sales_trend | map(attribute = 'count') | list | tojson }},
        borderColor: chartColors.green,
        backgroundColor: chartColors.green + '20',
        tension: 0.4,
        fill: true
        }]
    },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

    // Top Selling Books Chart
    const topSellingCtx = document.getElementById('topSellingBooksChart').getContext('2d');
    new Chart(topSellingCtx, {
        type: 'bar',
        data: {
            labels: {{ stats.top_selling_books | map(attribute = 'title') | list | tojson }},
        datasets: [{
            label: 'Copies Sold',
            data: {{ stats.top_selling_books | map(attribute = 'count') | list | tojson }},
        backgroundColor: [chartColors.blue, chartColors.purple, chartColors.amber, chartColors.green, chartColors.red]
        }]
    },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

    // Category Stock Chart
    const categoryCtx = document.getElementById('categoryStockChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: {{ stats.category_data | map(attribute = 'category') | list | tojson }},
        datasets: [{
            data: {{ stats.category_data | map(attribute = 'stock') | list | tojson }},
        backgroundColor: [chartColors.blue, chartColors.purple, chartColors.amber, chartColors.green, chartColors.red]
        }]
    },
        options: {
        responsive: true,
        maintainAspectRatio: false
    }
});
</script>
{% endblock %}