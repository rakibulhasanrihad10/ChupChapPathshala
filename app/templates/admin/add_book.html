{% extends "base.html" %}

{% block title %}Add New Book{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Add New Book</h1>
</div>

<div class="p-8 rounded-2xl shadow max-w-xl mx-auto border" style="background-color: var(--card-bg); border-color: var(--border-color);">
    <form method="POST">

        <!-- ISBN Search Section -->
        <div class="p-4 rounded-lg mb-6 border border-dashed" style="background-color: var(--bg-color); border-color: var(--border-color);">
            <label class="block font-semibold mb-2" style="color: var(--text-muted);">Auto-fill Details</label>

            <div class="flex gap-2">
                <input id="isbn_search" type="text"
                    placeholder="Enter ISBN (e.g. 9780140328721)"
                    class="flex-1 p-3 rounded-lg outline-none border" 
                    style="background-color: var(--card-bg); color: var(--text-color); border-color: var(--border-color);" />

                <button type="button" onclick="fetchBookByISBN()"
                    class="text-white px-6 rounded-lg font-medium cursor-pointer" style="background-color: var(--primary-color);">
                    Search
                </button>
            </div>

            <p id="search_status" class="mt-2 text-sm" style="color: var(--text-muted);"></p>
        </div>

        <!-- Book Name Search Section -->
        <div class="p-4 rounded-lg mb-6 border border-dashed" style="background-color: var(--bg-color); border-color: var(--border-color);">
            <label class="block font-semibold mb-2" style="color: var(--text-muted);">Search by Book Name</label>

            <div class="flex gap-2">
                <input id="title_search" type="text"
                    placeholder="Enter book name (e.g. The Alchemist)"
                    class="flex-1 p-3 rounded-lg outline-none border" 
                    style="background-color: var(--card-bg); color: var(--text-color); border-color: var(--border-color);" />

                <button type="button" onclick="searchBooksByTitle()"
                    class="text-white px-6 rounded-lg font-medium cursor-pointer" style="background-color: var(--primary-color);">
                    Search
                </button>
            </div>

            <p id="title_search_status" class="mt-2 text-sm" style="color: var(--text-muted);"></p>
            
            <!-- Result List Container -->
            <div id="book_search_results" class="mt-3 flex flex-col gap-2 max-h-60 overflow-y-auto hidden">
                <!-- Javascript will populate this -->
            </div>
        </div>

        <!-- Title -->
        <div class="mb-6">
            <label class="block font-medium mb-2" style="color: var(--text-color);">Title</label>
            <input name="title" type="text" required
                class="w-full p-3 border rounded-lg outline-none transition-colors"
                style="background-color: var(--bg-color); color: var(--text-color); border-color: var(--border-color);">
        </div>

        <!-- Author -->
        <div class="mb-6">
            <label class="block font-medium mb-2" style="color: var(--text-color);">Author</label>
            <input name="author" type="text" required
                class="w-full p-3 border rounded-lg outline-none"
                style="background-color: var(--bg-color); color: var(--text-color); border-color: var(--border-color);">
        </div>

        <!-- Image URL -->
        <div class="mb-6">
            <label class="block font-medium mb-2" style="color: var(--text-color);">Image URL (Poster)</label>
            <input name="image_url" type="url" placeholder="https://..."
                class="w-full p-3 border rounded-lg outline-none"
                style="background-color: var(--bg-color); color: var(--text-color); border-color: var(--border-color);">
        </div>

        <!-- Price + Stock -->
        <div class="grid grid-cols-2 gap-4">
            <div class="mb-6">
                <label class="block font-medium mb-2" style="color: var(--text-color);">Price</label>
                <input name="price" type="number" step="0.01" required
                    class="w-full p-3 border rounded-lg outline-none"
                    style="background-color: var(--bg-color); color: var(--text-color); border-color: var(--border-color);">
            </div>

            <div class="mb-6">
                <label class="block font-medium mb-2" style="color: var(--text-color);">Total Stock</label>
                <input name="stock_total" type="number" value="1" required
                    class="w-full p-3 border rounded-lg outline-none"
                    style="background-color: var(--bg-color); color: var(--text-color); border-color: var(--border-color);">
            </div>
        </div>

        <!-- Category -->
        <div class="mb-6">
            <label class="block font-medium mb-2" style="color: var(--text-color);">Category</label>
            <select name="category"
                class="w-full p-3 border rounded-lg outline-none"
                style="background-color: var(--bg-color); color: var(--text-color); border-color: var(--border-color);">
                {% for value, label in categories %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Availability -->
        <div class="mb-6">
            <label class="block font-medium mb-2" style="color: var(--text-color);">Availability (Sale/Borrow)</label>
            <select name="item_type"
                class="w-full p-3 border rounded-lg outline-none"
                style="background-color: var(--bg-color); color: var(--text-color); border-color: var(--border-color);">
                <option value="circulation">Circulation (Borrow Only)</option>
                <option value="sale">Sale (Purchase Only)</option>
                <option value="hybrid">Hybrid (Both)</option>
            </select>
        </div>

        <!-- Location -->
        <div class="mb-8">
            <label class="block font-medium mb-2" style="color: var(--text-color);">Location</label>
            <input name="location" type="text" placeholder="e.g. Aisle 3, Shelf B"
                class="w-full p-3 border rounded-lg outline-none"
                style="background-color: var(--bg-color); color: var(--text-color); border-color: var(--border-color);">
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-4">
            <input type="submit" value="Add Book"
                class="btn-add cursor-pointer text-lg" />

            <a href="{{ url_for('main.inventory') }}"
                class="font-medium hover:opacity-75" style="color: var(--text-muted);">
                Cancel
            </a>
        </div>

    </form>
</div>

<script>
    async function fetchBookByISBN() {
        const isbnInput = document.getElementById('isbn_search');
        const statusMsg = document.getElementById('search_status');
        const isbn = isbnInput.value.trim().replace(/-/g, '');

        if (!isbn) {
            statusMsg.textContent = 'Please enter an ISBN number.';
            statusMsg.classList = 'mt-2 text-sm text-red-500';
            return;
        }

        statusMsg.textContent = 'Searching Open Library...';
        statusMsg.classList = 'mt-2 text-sm text-gray-500';

        try {
            const response = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&jscmd=data&format=json`);
            const data = await response.json();
            const bookData = data[`ISBN:${isbn}`];

            if (bookData) {
                document.querySelector('input[name="title"]').value = bookData.title || '';

                if (bookData.authors?.length > 0) {
                    document.querySelector('input[name="author"]').value = bookData.authors[0].name;
                }

                if (bookData.cover) {
                    document.querySelector('input[name="image_url"]').value =
                        bookData.cover.large || bookData.cover.medium || bookData.cover.small || '';
                }

                if (bookData.subjects) {
                    const subjects = bookData.subjects.map(s => s.name.toLowerCase());
                    const categorySelect = document.querySelector('select[name="category"]');

                    if (subjects.some(s => s.includes('islam'))) categorySelect.value = 'Islamic';
                    else if (subjects.some(s => s.includes('bengali') || s.includes('india'))) categorySelect.value = 'Bengali';
                    else if (subjects.some(s => s.includes('fiction'))) categorySelect.value = 'Fiction';
                    else if (subjects.some(s => s.includes('history') || s.includes('science'))) categorySelect.value = 'Non-Fiction';
                }

                statusMsg.textContent = 'Success! details found.';
                statusMsg.classList = 'mt-2 text-sm text-green-600';

            } else {
                statusMsg.textContent = 'Book not found for this ISBN.';
                statusMsg.classList = 'mt-2 text-sm text-red-500';
            }

        } catch (error) {
            console.error(error);
            statusMsg.textContent = 'Error fetching data. Please try again.';
            statusMsg.classList = 'mt-2 text-sm text-red-500';
        }
    }
    async function searchBooksByTitle() {
        const queryInput = document.getElementById('title_search');
        const statusMsg = document.getElementById('title_search_status');
        const resultsContainer = document.getElementById('book_search_results');
        const query = queryInput.value.trim();

        if (!query) {
            statusMsg.textContent = 'Please enter a book name.';
            statusMsg.className = 'mt-2 text-sm text-red-500';
            return;
        }

        statusMsg.textContent = 'Searching Google Books...';
        statusMsg.className = 'mt-2 text-sm text-gray-500';
        resultsContainer.innerHTML = '';
        resultsContainer.classList.add('hidden');

        try {
            const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=5`);
            const data = await response.json();

            if (data.items && data.items.length > 0) {
                statusMsg.textContent = `Found ${data.items.length} results.`;
                statusMsg.className = 'mt-2 text-sm text-green-600';
                displaySearchResults(data.items);
            } else {
                statusMsg.textContent = 'No books found with that name.';
                statusMsg.className = 'mt-2 text-sm text-red-500';
            }
        } catch (error) {
            console.error(error);
            statusMsg.textContent = 'Error fetching data.';
            statusMsg.className = 'mt-2 text-sm text-red-500';
        }
    }

    function displaySearchResults(books) {
        const resultsContainer = document.getElementById('book_search_results');
        resultsContainer.innerHTML = '';
        resultsContainer.classList.remove('hidden');

        books.forEach(book => {
            const info = book.volumeInfo;
            const title = info.title || 'Unknown Title';
            const author = info.authors ? info.authors.join(', ') : 'Unknown Author';
            const thumb = info.imageLinks ? info.imageLinks.smallThumbnail : '';
            
            const div = document.createElement('div');
            div.className = 'p-3 border rounded-lg cursor-pointer flex gap-3 items-center transition-colors';
            div.style.borderColor = 'var(--border-color)';
            div.style.backgroundColor = 'var(--card-bg)';
            div.onmouseover = () => div.style.opacity = '0.8';
            div.onmouseout = () => div.style.opacity = '1';

            div.innerHTML = `
                ${thumb ? `<img src="${thumb}" class="w-12 h-16 object-cover rounded">` : '<div class="w-12 h-16 bg-gray-500 rounded flex items-center justify-center text-xs text-white">No img</div>'}
                <div>
                    <h4 class="font-bold text-sm" style="color: var(--text-color);">${title}</h4>
                    <p class="text-xs" style="color: var(--text-muted);">${author}</p>
                </div>
            `;
            
            div.onclick = () => selectBook(info);
            resultsContainer.appendChild(div);
        });
    }

    function selectBook(info) {

        document.querySelector('input[name="title"]').value = info.title || '';
        document.querySelector('input[name="author"]').value = info.authors ? info.authors[0] : '';
        
        if (info.imageLinks) {
            document.querySelector('input[name="image_url"]').value = info.imageLinks.thumbnail || info.imageLinks.smallThumbnail || '';
        }

        if (info.categories) {
            const cats = info.categories.map(c => c.toLowerCase());
            const categorySelect = document.querySelector('select[name="category"]');
            
            if (cats.some(s => s.includes('islam'))) categorySelect.value = 'Islamic';
            else if (cats.some(s => s.includes('bengali') || s.includes('india'))) categorySelect.value = 'Bengali';
            else if (cats.some(s => s.includes('fiction'))) categorySelect.value = 'Fiction';
            else if (cats.some(s => s.includes('history') || s.includes('science'))) categorySelect.value = 'Non-Fiction';
            // ... otherwise keep default or user selected
        }

        // Hide results after selection 
        document.getElementById('book_search_results').classList.add('hidden');
        document.getElementById('title_search_status').textContent = 'Selected: ' + info.title;
        document.getElementById('title_search_status').className = 'mt-2 text-sm text-green-600';
    }
</script>

{% endblock %}
