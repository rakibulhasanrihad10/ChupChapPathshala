<div class="mb-12">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold" style="color: var(--text-color);">Popular Books</h2>
        <a href="{{ url_for('main.catalog') }}" class="text-indigo-600 font-semibold hover:underline">
            View All Books →
        </a>
    </div>

    <div class="features-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
        {% for book in books %}
        <div class="card" style="display: flex; flex-direction: column; overflow: hidden; position: relative;">
            
            <!-- Copies Sold Badge (Preserved from original design) -->
            <div style="position: absolute; top: 1rem; left: 1rem; z-index: 10;">
                <div style="background-color: #10B981; color: white; padding: 0.5rem; border-radius: 9999px; font-weight: bold; font-size: 0.9rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    {{book.stock_sold}} <span style="font-size: 0.8em; font-weight: normal;">sold</span>
                </div>
            </div>

            <div class="book-image-container">
                {% if book.image_url %}
                <img src="{{ book.image_url }}" alt="{{ book.title }}"
                    style="height: 100%; width: 100%; object-fit: cover;" id="img-{{ book.id }}">
                {% else %}
                <div class="no-cover-placeholder" id="img-{{ book.id }}">
                    <span>No Cover</span>
                </div>
                {% endif %}
                
                {% if book.discount_percentage and book.discount_percentage > 0 %}
                <div class="discount-badge">
                    <span class="discount-value">{{ "%.0f"|format(book.discount_percentage) }}%</span>
                    <span class="discount-label">OFF</span>
                </div>
                {% endif %}
                
                {% if current_user.is_staff() %}
                <div class="upload-overlay" onclick="document.getElementById('file-{{ book.id }}').click()">
                    <div class="upload-btn">+</div>
                </div>
                <!-- Loading Spinner -->
                <div id="spinner-{{ book.id }}" class="upload-spinner">↻</div>
                
                <input type="file" id="file-{{ book.id }}" accept="image/*" style="display: none;" 
                       onchange="uploadCover(this, {{ book.id }})">
                {% endif %}
            </div>
            
            <h3>{{ book.title }}</h3>
            <p><strong>Author:</strong> {{ book.author }}</p>
            <p><strong>Availability:</strong> <span
                    class="status-badge">{{
                    book.item_type|capitalize }}</span></p>
            <p><strong>Category:</strong> <span style="color: #6B7280;">{{ book.category }}</span></p>
            <p>
                <strong>Price:</strong>
                {% if book.discount_percentage and book.discount_percentage > 0 %}
                <span class="text-red-500 line-through mr-1">TK {{ "%.2f"|format(book.price) }}</span>
                <span class="text-green-600 font-bold">TK {{ "%.2f"|format(book.price * (1 - book.discount_percentage/100)) }}</span>
                {% else %}
                TK {{ "%.2f"|format(book.price) }}
                {% endif %}
            </p>
            
            <!-- Removed Creating Stock since this is Popular Books view, replaced with Sold count up top -->

            <!-- Action Buttons Grid -->
            <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                
                {% set show_buy = (book.item_type in ['sale', 'hybrid'] and book.stock_available > 0) %}
                {% set show_borrow = (book.item_type in ['circulation', 'hybrid'] and book.stock_available > 0) %}
                
                <form action="{{ url_for('main.add_to_cart', book_id=book.id) }}" method="POST" style="display: contents;">
                    {% if show_buy %}
                    <button type="submit" name="action" value="buy" class="btn-action btn-buy" 
                        style="{{ 'grid-column: span 2;' if not show_borrow else '' }}">Buy</button>
                    {% endif %}

                    {% if show_borrow %}
                    <button type="submit" name="action" value="borrow" class="btn-action btn-borrow"
                        style="{{ 'grid-column: span 2;' if not show_buy else '' }}">Borrow</button>
                    {% endif %}

                    {% if book.stock_available == 0 %}
                    <button disabled class="btn-action btn-disabled" style="grid-column: span 2;">Out of Stock</button>
                    {% endif %}
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
