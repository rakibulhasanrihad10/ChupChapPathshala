{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero">
    <h1>Welcome to ChupChap Pathshala</h1>
    <p>Your portal to knowledge</p>
    <p>Discover, Borrow and Own your favorite books.</p>

    {% if not current_user.is_authenticated %}
    <div style="margin-top: 1.5rem;">
        <a href="{{ url_for('auth.register') }}" class="btn btn-primary">Join Now</a>
        <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">Login</a>
    </div>
    {% endif %}
</div>

<!-- Categories Section -->
<div style="margin-bottom: 3rem;">
    <h2 style="font-size: 1.5rem; color: #111827; font-weight: 700; margin-bottom: 1.5rem;">Shop by Category</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <!-- Bengali -->
        <a href="{{ url_for('main.catalog', category='Bengali') }}" style="text-decoration: none; color: inherit;">
            <div style="background: linear-gradient(135deg, #75ced1, #44e9ef); padding: 0.75rem; border-radius: 0.75rem; color: white; text-align: center; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">Bengali</h3>
                <p style="margin: 0.5rem 0 0; opacity: 0.9; font-size: 0.9rem;">Literature & Classics</p>
            </div>
        </a>
        <!-- Islamic -->
        <a href="{{ url_for('main.catalog', category='Islamic') }}" style="text-decoration: none; color: inherit;">
            <div style="background: linear-gradient(135deg, #2d6fd3, #8c82e4); padding: 0.75rem; border-radius: 0.75rem; color: white; text-align: center; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">Islamic</h3>
                <p style="margin: 0.5rem 0 0; opacity: 0.9; font-size: 0.9rem;">Religion & History</p>
            </div>
        </a>
         <!-- Children -->
        <a href="{{ url_for('main.catalog', category='Children') }}" style="text-decoration: none; color: inherit;">
            <div style="background: linear-gradient(135deg, #60A5FA, #3B82F6); padding: 0.75rem; border-radius: 0.75rem; color: white; text-align: center; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">Children</h3>
                <p style="margin: 0.5rem 0 0; opacity: 0.9; font-size: 0.9rem;">Stories & Fun</p>
            </div>
        </a>
         <!-- Academic -->
        <a href="{{ url_for('main.catalog', category='Academic') }}" style="text-decoration: none; color: inherit;">
            <div style="background: linear-gradient(135deg, #a7ee36, #ec6f09); padding: 0.75rem; border-radius: 0.75rem; color: white; text-align: center; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">Academic</h3>
                <p style="margin: 0.5rem 0 0; opacity: 0.9; font-size: 0.9rem;">School & Learning</p>
            </div>
        </a>
    </div>
</div>

<!-- Featured Books Section -->
<div style="margin-bottom: 3rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.5rem; color: #111827; font-weight: 700;">Featured Books</h2>
        <a href="{{ url_for('main.catalog') }}" style="color: #4F46E5; font-weight: 600; text-decoration: none;">View
            All Books &rarr;</a>
    </div>

    <div class="features-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
        {% for book in books %}
        <div class="card" style="display: flex; flex-direction: column; overflow: hidden;">
            <div class="book-image-container">
                <img src="{{ book.image_url or 'https://placehold.co/150x220?text=No+Cover' }}" alt="{{ book.title }}"
                    style="height: 100%; width: 100%; object-fit: cover;" id="img-{{ book.id }}">
                
                {% if current_user.is_staff() %}
                <div class="upload-overlay" onclick="document.getElementById('file-{{ book.id }}').click()">
                    <div class="upload-btn">+</div>
                </div>
                <!-- Loading Spinner -->
                <div id="spinner-{{ book.id }}" class="upload-spinner">↻</div>
                
                <input type="file" id="file-{{ book.id }}" accept="image/*" style="display: none;" 
                       onchange="uploadCover(this, {{ book.id }})">
                {% endif %}
            </div>
            <h3>{{ book.title }}</h3>
            <p><strong>Author:</strong> {{ book.author }}</p>
            <p><strong>Availability:</strong> <span
                    style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">{{
                    book.item_type|capitalize }}</span></p>
            <p><strong>Category:</strong> <span style="color: #6B7280;">{{ book.category }}</span></p>
            <p><strong>Price:</strong> {{ "%.2f"|format(book.price) }}</p>
            <!-- Note: Displaying stock but action buttons require login/cart logic which is handled below -->

            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                <form action="{{ url_for('main.add_to_cart', book_id=book.id) }}" method="POST" style="width: 100%;">
                    {% if book.item_type in ['sale', 'hybrid'] and book.stock_available > 0 %}
                    <button type="submit" name="action" value="buy" class="btn-action btn-buy"
                        style="margin-bottom: 0.5rem;">Buy</button>
                    {% endif %}

                    {% if book.item_type in ['circulation', 'hybrid'] and book.stock_available > 0 %}
                    <button type="submit" name="action" value="borrow" class="btn-action btn-borrow">Borrow</button>
                    {% endif %}

                    {% if book.stock_available == 0 %}
                    <button disabled
                        class="btn-action btn-disabled">Out of Stock</button>
                    {% endif %}
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Promotional / Premium Perks Section -->
<!-- Promotional / Premium Perks Section -->
<div class="premium-perks">
    <div>
        <h2 style="font-size: 2rem; font-weight: 800; margin-bottom: 1rem;">Unlock Premium Perks</h2>
        <p style="font-size: 1.1rem; line-height: 1.6; opacity: 0.9; margin-bottom: 1.5rem;">
            Upgrade your membership to get exclusive access to our entire digital archive, extended borrowing limits (up
            to 10 books), and free home delivery on all purchases.
        </p>
        <ul style="list-style: none; padding: 0; margin-bottom: 2rem;">
            <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 50%;">✓</span> Extra
                Borrowing Time
            </li>
            <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 50%;">✓</span> Free
                Delivery
            </li>
            <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 50%;">✓</span> Priority
                Support
            </li>
        </ul>
        <a href="#"
            style="background: white; color: #4F46E5; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; text-decoration: none; display: inline-block;">Learn
            More</a>
    </div>

    <!-- Visual Element (Simple Card Representation or Illustration Placeholder) -->
    <div
        style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 1rem; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Extensive Catalog Access</h3>
        <p style="opacity: 0.9; margin-bottom: 1.5rem;">Browse thousands of titles from our extensive collection. From
            rare Bengali classics to modern international bestsellers.</p>
        <a href="{{ url_for('main.catalog') }}"
            style="width: 100%; display: block; text-align: center; padding: 0.75rem; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 0.5rem; font-weight: 600; transition: background 0.2s;">Explore
            Full Catalog</a>
    </div>
</div>
<script>
function uploadCover(input, bookId) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Client-side validation: Check file size (16MB limit)
        if (file.size > 16 * 1024 * 1024) {
            alert('File is too large. Maximum size is 16MB.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        
        // Show Spinner / Hide overlay
        const spinner = document.getElementById(`spinner-${bookId}`);
        // Ensure overlay can be hidden if needed, though mostly spinner is enough context
        
        if(spinner) spinner.style.display = 'block';
        
        fetch(`/upload_cover/${bookId}`, {
            method: 'POST',
            body: formData
        })
        .then(async response => {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            } else {
                // If response is not JSON (e.g., 413 HTML from Nginx/Flask, or 500)
                const text = await response.text();
                throw new Error(`Server returned non-JSON response: ${response.status} ${response.statusText}. Response: ${text.substring(0, 100)}...`);
            }
        })
        .then(data => {
            if (data.success) {
                // Update Image Source
                const img = document.getElementById(`img-${bookId}`);
                if(img) img.src = data.image_url + '?t=' + new Date().getTime();
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed. Check console for details.\n' + error.message);
        })
        .finally(() => {
            if(spinner) spinner.style.display = 'none';
            // Clear input so same file can be selected again if needed
            input.value = '';
        });
    }
}
</script>
{% endblock %}