{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<style>
    /* Campaign Mobile Responsiveness */
    @media (max-width: 768px) {
        .campaignSwiper .hero {
            min-height: 300px !important;
            padding: 1.5rem 1rem !important;
        }
        
        .campaignSwiper .hero h1 {
            font-size: 1.5rem !important;
            margin-bottom: 0.75rem !important;
            line-height: 1.3 !important;
        }
        
        .campaignSwiper .hero p {
            font-size: 0.95rem !important;
            margin-bottom: 1rem !important;
            line-height: 1.5 !important;
        }
        
        .campaignSwiper .btn {
            font-size: 0.9rem !important;
            padding: 0.625rem 1.5rem !important;
        }
    }
    
    @media (max-width: 640px) {
        .campaignSwiper .hero {
            min-height: 280px !important;
            padding: 1.25rem 0.875rem !important;
        }
        
        .campaignSwiper .hero h1 {
            font-size: 1.25rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .campaignSwiper .hero p {
            font-size: 0.875rem !important;
            margin-bottom: 0.875rem !important;
            max-width: 100% !important;
        }
        
        .campaignSwiper .btn {
            font-size: 0.875rem !important;
            padding: 0.5rem 1.25rem !important;
        }
    }
</style>

<!-- Hero Section -->
<div class="hero-swiper swiper campaignSwiper" style="border-radius: 1rem; overflow: hidden; margin-bottom: 2rem;">
    <div class="swiper-wrapper">
        <!-- Default Welcome Slide -->
        <div class="swiper-slide hero" style="
            border-radius: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
            min-height: 400px;
        ">
            <h1>Welcome to ChupChap Pathshala</h1>
            <p>Your portal to knowledge</p>
            <p>Discover, Borrow and Own your favorite books.</p>

            {% if not current_user.is_authenticated %}
            <div style="margin-top: 1.5rem;">
                <a href="{{ url_for('auth.register') }}" class="btn btn-primary">Join Now</a>
                <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">Login</a>
            </div>
            {% endif %}
        </div>

        <!-- Campaign Slides -->
        {% for campaign in campaigns %}
        <div class="swiper-slide hero" style="
            border-radius: 1rem;
            overflow: hidden;
            background-image: {% if campaign.image_url %}url('{{ campaign.image_url }}'){% else %}linear-gradient(135deg, #667eea 0%, #764ba2 100%){% endif %};
            background-size: cover;
            background-position: center;
            position: relative;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 2rem;
        ">
            <!-- Overlay for better text readability if image exists -->
            {% if campaign.image_url %}
            <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 1;"></div>
            {% endif %}

            <div style="position: relative; z-index: 2;">
                <h1
                    style="font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    {{ campaign.title }}</h1>
                {% if campaign.description %}
                <p
                    style="font-size: 1.25rem; margin-bottom: 1.5rem; max-width: 600px; margin-left: auto; margin-right: auto; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                    {{ campaign.description }}</p>
                {% endif %}

                <a href="{{ campaign.button_link }}" class="btn btn-primary"
                    style="font-size: 1.1rem; padding: 0.75rem 2rem;">{{ campaign.button_text }}</a>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="swiper-pagination"></div>
</div>

<!-- Categories Section -->
<div style="margin-bottom: 3rem;">
    <h2 style="font-size: 1.5rem; color: var(--text-color); font-weight: 700; margin-bottom: 1.5rem;">Shop by Category
    </h2>
    <div class="category-scroll-container">
        {% for category in categories %}
        <a href="{{ url_for('main.catalog', category=category.name) }}" class="category-item-link">
            <div class="category-card"
                style="background: linear-gradient(135deg, {{ loop.cycle('#75ced1, #44e9ef', '#2d6fd3, #8c82e4', '#60A5FA, #3B82F6', '#08e0d2, #12e4af', '#f59e0b, #fbbf24', '#ec4899, #f472b6') }});"
                onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                <h3>{{ category.name }}</h3>
                <p>Explore Collection</p>
            </div>
        </a>
        {% endfor %}
    </div>
</div>

<!-- Featured Books Section -->
{% include "featured.html" %}

<!-- Promotional / Premium Perks Section -->
<div class="premium-perks">
    <div>
        <h2 style="font-size: 2rem; font-weight: 800; margin-bottom: 1rem;">Unlock Premium Perks</h2>
        <p style="font-size: 1.1rem; line-height: 1.6; opacity: 0.9; margin-bottom: 1.5rem;">
            Upgrade your membership to get exclusive access to our entire digital archive, extended borrowing limits (up
            to 10 books), and free home delivery on all purchases.
        </p>
        <ul style="list-style: none; padding: 0; margin-bottom: 2rem;">
            <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 50%;">✓</span> Extra
                Borrowing Time
            </li>
            <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 50%;">✓</span> Free
                Delivery
            </li>
            <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 50%;">✓</span> Priority
                Support
            </li>
        </ul>
    </div>

    <div
        style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 1rem; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">

        <a href="{{ url_for('main.catalog') }}"
            style="width: 100%; display: block; text-align: center; padding: 0.75rem; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 0.5rem; font-weight: 600; transition: background 0.2s;">Explore
            Full Catalog</a>
    </div>
</div>

<!-- Owner/Management Section -->
<div class="management-grid">
    <!-- Top (Chairman) -->
    <div class="management-row-top">
        {% for member in management_members %}
        {% if member.display_order == 1 %}
        <div class="management-card">
            <div class="management-header">{{ member.designation }}</div>
            <div class="management-body">
                <div class="management-name">{{ member.name }}</div>
                <div class="management-img-wrapper">
                    {% if member.image_file.startswith('http') %}
                    <img src="{{ member.image_file }}" alt="{{ member.designation }}" class="management-img">
                    {% else %}
                    <img src="{{ url_for('static', filename=member.image_file) }}" alt="{{ member.designation }}" class="management-img">
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    
    <!-- Others -->
    <div class="management-row-bottom">
        {% for member in management_members %}
        {% if member.display_order != 1 %}
        <div class="management-card">
            <div class="management-header">{{ member.designation }}</div>
            <div class="management-body">
                <div class="management-name">{{ member.name }}</div>
                <div class="management-img-wrapper">
                    {% if member.image_file.startswith('http') %}
                    <img src="{{ member.image_file }}" alt="{{ member.designation }}" class="management-img">
                    {% else %}
                    <img src="{{ url_for('static', filename=member.image_file) }}" alt="{{ member.designation }}" class="management-img">
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        if (document.querySelector('.campaignSwiper')) {
            new Swiper(".campaignSwiper", {
                slidesPerView: 1,
                loop: true,
                autoplay: {
                    delay: 5000,
                    disableOnInteraction: false,
                },
                pagination: {
                    el: ".swiper-pagination",
                    clickable: true,
                },
            });
        }
    });

    function uploadCover(input, bookId) {
        if (input.files && input.files[0]) {
            const file = input.files[0];

            // Client-side validation: Check file size (16MB limit)
            if (file.size > 16 * 1024 * 1024) {
                alert('File is too large. Maximum size is 16MB.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // Show Spinner / Hide overlay
            const spinner = document.getElementById(`spinner-${bookId}`);

            if (spinner) spinner.style.display = 'block';

            fetch(`/upload_cover/${bookId}`, {
                method: 'POST',
                body: formData
            })
                .then(async response => {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(`Server returned non-JSON response: ${response.status} ${response.statusText}. Response: ${text.substring(0, 100)}...`);
                    }
                })
                .then(data => {
                    if (data.success) {
                        const img = document.getElementById(`img-${bookId}`);
                        if (img) img.src = data.image_url + '?t=' + new Date().getTime();
                    } else {
                        alert('Upload failed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Upload failed. Check console for details.\n' + error.message);
                })
                .finally(() => {
                    if (spinner) spinner.style.display = 'none';
                    input.value = '';
                });
        }
    }
</script>
{% endblock %}